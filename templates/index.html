<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE ONE V3 - Tasks</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO client library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: #F5F5F5; color: #333333; min-height: 100vh; padding: 1.5rem; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; }
        header { text-align: center; margin-bottom: 1.5rem; }
        .header-top { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; }
        .header-top h1 { font-size: 2.5rem; font-weight: 600; color: #222222; margin: 0; cursor: pointer; user-select: none; padding: 0.25rem 0.5rem; border-radius: 8px; transition: background-color 0.2s ease; }
        .header-top h1:hover { background-color: #EAEAEA; }
        .date-nav { display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .nav-arrow { font-size: 1.8rem; font-weight: 300; color: #555; cursor: pointer; padding: 0 0.5rem; border-radius: 8px; transition: background-color 0.2s ease, color 0.2s ease; user-select: none; }
        .nav-arrow:hover { background-color: #EAEAEA; color: #000; }
        header .date { font-size: 1.1rem; font-weight: 400; color: #666666; min-width: 210px; text-align: center; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 8px; transition: background-color 0.2s ease, color 0.2s ease; user-select: none; }
        header .date:hover { background-color: #EAEAEA; color: #000; }
        .analytics-container { padding-top: 1rem; }
        .chart-container { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .chart-container h2 { text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem; color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .stat-card .value { font-size: 2.5rem; font-weight: 600; color: #000; }
        .stat-card .label { font-size: 0.9rem; color: #666; margin-top: 0.25rem; }
        .data-management-card { background: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .data-management-card h2 { text-align: center; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #333; }
        .welcome-message { text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 1.5rem; }
        .data-actions { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .data-actions button { padding: 0.6rem 1.25rem; border: 2px solid #E0E0E0; background: #FFFFFF; cursor: pointer; font-size: 0.85rem; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; }
        .data-actions button:hover { background: #f0f0f0; border-color: #ccc; }
        .add-task-btn { position: fixed; bottom: 1.5rem; right: 1.5rem; width: 60px; height: 60px; background: #000000; color: #FFFFFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 999; }
        .add-task-btn:hover { transform: scale(1.1); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.2); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: #FFFFFF; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); }
        .modal-content input[type="text"], .modal-content input[type="number"], .modal-content select { width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 2px solid #E0E0E0; font-size: 0.9rem; border-radius: 8px; transition: border-color 0.3s ease; background: #FFFFFF; -webkit-appearance: none; appearance: none; }
        .modal-content input[type="number"]::-webkit-outer-spin-button, .modal-content input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .modal-content input[type="text"]:focus, .modal-content input[type="number"]:focus, .modal-content select:focus { border-color: #000000; outline: none; }
        #newGroupInput { margin-top: 0.5rem; }
        .days-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 0.5rem; margin-bottom: 1.5rem; }
        .day-btn { padding: 0.5rem; border: 2px solid #E0E0E0; background: #FFFFFF; cursor: pointer; text-align: center; font-size: 0.85rem; border-radius: 8px; transition: all 0.2s ease; }
        .day-btn.selected { background: #000000; color: #FFFFFF; border-color: #000000; }
        .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; flex-wrap: wrap; margin-top: 1.5rem; }
        .modal-actions button { padding: 0.6rem 1.25rem; border: 2px solid #E0E0E0; background: #FFFFFF; cursor: pointer; font-size: 0.85rem; border-radius: 8px; transition: all 0.2s ease; }
        .modal-actions button:hover { background: #000000; color: #FFFFFF; border-color: #000000; }
        #deleteGroupModal .modal-content, #habitGoalModal .modal-content { text-align: center; }
        #deleteGroupModalText { font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.5; }
        .btn-danger { border-color: #FF3B30; color: #FF3B30; }
        .btn-danger:hover { background: #FF3B30; border-color: #FF3B30; color: #FFFFFF; }
        .task-list { list-style: none; }
        .task-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #E0E0E0; cursor: pointer; transition: background 0.2s ease; }
        .task-item:hover { background: #F0F0F0; }
        .task-item.completed .task-text { text-decoration: line-through; opacity: 0.6; }
        .task-checkbox { width: 22px; height: 22px; border: 2px solid #333333; border-radius: 50%; position: relative; margin-right: 0.75rem; cursor: pointer; appearance: none; transition: all 0.3s ease; flex-shrink: 0; background: #FFFFFF; }
        .task-checkbox:checked::before { content: ''; position: absolute; top: 50%; left: 50%; width: 10px; height: 6px; border-left: 2px solid #333333; border-bottom: 2px solid #333333; transform: translate(-50%, -70%) rotate(-45deg); }
        .task-text { flex-grow: 1; font-size: 0.9rem; word-break: break-word; margin-right: 0.5rem; }
        .group-header { font-size: 1rem; font-weight: 500; padding: 0.75rem 0.5rem; margin-top: 1rem; border-bottom: 1px solid #E0E0E0; color: #222222; }
        .group-header.deletable { cursor: pointer; border-radius: 6px; transition: background-color 0.2s ease; }
        .group-header.deletable:hover { background-color: #EAEAEA; }
        .task-meta { display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
        .habit-tracker { font-size: 0.75rem; background-color: #E0EAFC; color: #3F51B5; padding: 2px 6px; border-radius: 4px; font-weight: 500; cursor: pointer; user-select: none; transition: background-color 0.2s ease; }
        .habit-tracker:hover { background-color: #C5CAE9; }
        .habit-formed { font-size: 0.75rem; background-color: #C8E6C9; color: #2E7D32; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
    </style>
</head>
<body>
    <!-- CORRECTED: The data-tasks attribute now correctly gets the JSON from the server -->
    <div id="initial-data" data-tasks='{{ initial_tasks | tojson }}' style="display: none;"></div>

    <div class="container">
        <header>
            <div class="header-top"><h1></h1></div>
            <div class="date-nav">
                <span class="nav-arrow" id="prevDayBtn">‹</span>
                <div class="date" id="currentDate"></div>
                <span class="nav-arrow" id="nextDayBtn">›</span>
            </div>
        </header>

        <div id="tasksContainer">
             <ul class="task-list" id="taskList"></ul>
        </div>

        <div id="analyticsContainer" style="display: none;">
            <div class="stats-grid"><div class="stat-card"><div class="value" id="totalCompletedStat">0</div><div class="label">Total Tasks Completed</div></div><div class="stat-card"><div class="value" id="productiveDayStat">-</div><div class="label">Most Productive Day</div></div></div>
            <div class="chart-container"><h2>Completion Trend (Last 14 Days)</h2><canvas id="completionTrendChart"></canvas></div>
            <div class="data-management-card">
                <h2>Data & Account</h2>
                <div class="welcome-message" id="welcomeMessage"></div>
                <div class="data-actions"><button id="importBtn">Import Data</button><button id="exportBtn">Export Data</button><button id="logoutBtn" class="btn-danger">Logout</button></div>
            </div>
        </div>
    </div>

    <div class="add-task-btn" id="addTaskBtn">+</div>
    <input type="file" id="importFileInput" style="display: none;" accept="application/json">
    <div class="modal" id="taskModal"><div class="modal-content"><input type="text" id="taskInput" placeholder="Enter task"><select id="groupSelect"></select><input type="text" id="newGroupInput" placeholder="Enter new group name" style="display: none;"><div class="days-selection" id="daysSelection"><button class="day-btn" data-day="Daily">Daily</button><button class="day-btn" data-day="Mo">Mo</button><button class="day-btn" data-day="Tu">Tu</button><button class="day-btn" data-day="We">We</button><button class="day-btn" data-day="Th">Th</button><button class="day-btn" data-day="Fr">Fr</button><button class="day-btn" data-day="Sa">Sa</button><button class="day-btn" data-day="Su">Su</button></div><div class="modal-actions"><button id="deleteBtn" style="display: none;">Delete Task</button><button id="cancelBtn">Cancel</button><button id="saveBtn">Save</button></div></div></div>
    <div class="modal" id="deleteGroupModal"><div class="modal-content"><p id="deleteGroupModalText"></p><div class="modal-actions"><button id="cancelDeleteGroupBtn">Cancel</button><button id="confirmDeleteGroupBtn" class="btn-danger">Confirm Delete</button></div></div></div>
    <div class="modal" id="habitGoalModal"><div class="modal-content"><h3 style="font-weight: 600; margin-bottom: 0.75rem;">Set Habit Goal</h3><p id="habitInfoText" style="color: #666; margin-bottom: 1.5rem; font-size: 0.9rem;"></p><label for="habitGoalInput" style="font-size: 0.9rem; margin-bottom: 0.5rem; display: block; text-align: left;">Goal (in days):</label><input type="number" id="habitGoalInput" placeholder="e.g., 21" min="1"><div class="modal-actions"><button id="cancelHabitGoalBtn">Cancel</button><button id="saveHabitGoalBtn">Save Goal</button></div></div></div>

    <script>
        // DOM Elements
        const headerTitle = document.querySelector('.header-top h1'); const tasksContainer = document.getElementById('tasksContainer'); const analyticsContainer = document.getElementById('analyticsContainer'); const taskList = document.getElementById('taskList'); const addTaskBtn = document.getElementById('addTaskBtn'); const dateNav = document.querySelector('.date-nav'); const currentDateElement = document.getElementById('currentDate'); const prevDayBtn = document.getElementById('prevDayBtn'); const nextDayBtn = document.getElementById('nextDayBtn'); const taskModal = document.getElementById('taskModal'); const taskInput = document.getElementById('taskInput'); const saveBtn = document.getElementById('saveBtn'); const cancelBtn = document.getElementById('cancelBtn'); const deleteBtn = document.getElementById('deleteBtn'); const daysSelection = document.getElementById('daysSelection'); const groupSelect = document.getElementById('groupSelect'); const newGroupInput = document.getElementById('newGroupInput'); const deleteGroupModal = document.getElementById('deleteGroupModal'); const deleteGroupModalText = document.getElementById('deleteGroupModalText'); const cancelDeleteGroupBtn = document.getElementById('cancelDeleteGroupBtn'); const confirmDeleteGroupBtn = document.getElementById('confirmDeleteGroupBtn'); const importBtn = document.getElementById('importBtn'); const exportBtn = document.getElementById('exportBtn'); const importFileInput = document.getElementById('importFileInput'); const habitGoalModal = document.getElementById('habitGoalModal'); const habitInfoText = document.getElementById('habitInfoText'); const habitGoalInput = document.getElementById('habitGoalInput'); const saveHabitGoalBtn = document.getElementById('saveHabitGoalBtn'); const cancelHabitGoalBtn = document.getElementById('cancelHabitGoalBtn'); const logoutBtn = document.getElementById('logoutBtn'); const welcomeMessage = document.getElementById('welcomeMessage');

        // State
        const initialDataEl = document.getElementById('initial-data');
        let tasks = JSON.parse(initialDataEl.dataset.tasks);
        let currentDisplayDate = new Date(); let editingTaskId = null; let editingHabitTaskId = null; let groupToDelete = null; let completionTrendChart = null;

        // --- REAL-TIME SERVER COMMUNICATION (WebSocket) ---
        const socket = io();
        let isSyncing = false; let syncTimeout;
        
        socket.on('tasks_updated', (updatedTasks) => {
            console.log('Received real-time task update from server.');
            tasks = updatedTasks;
            if (tasksContainer.style.display === 'block' || tasksContainer.style.display === '') {
                renderTasks();
            }
        });
        
        socket.on('connect', () => { console.log('WebSocket connected!'); });
        socket.on('disconnect', () => { console.log('WebSocket disconnected.'); });

        async function syncTasksToServer() { clearTimeout(syncTimeout); syncTimeout = setTimeout(async () => { if (isSyncing) return; isSyncing = true; try { const response = await fetch('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(tasks) }); if (!response.ok) throw new Error('Sync failed'); } catch (error) { console.error("Failed to sync tasks:", error); alert("Connection error: Could not save your changes."); } finally { isSyncing = false; } }, 200); }
        async function handleLogout() { try { const response = await fetch('/logout', { method: 'POST' }); if (response.ok) { window.location.href = '/login'; } else { alert('Logout failed.'); } } catch (error) { alert('Could not connect to the server to log out.'); } }

        // --- VIEW SWITCHING, ANALYTICS, DATA-MGMT ---
        function showTasksView() { tasksContainer.style.display = 'block'; analyticsContainer.style.display = 'none'; dateNav.style.visibility = 'visible'; addTaskBtn.style.display = 'flex'; headerTitle.textContent = 'Tasks'; updateView(); }
        function showAnalyticsView() { tasksContainer.style.display = 'none'; analyticsContainer.style.display = 'block'; dateNav.style.visibility = 'hidden'; addTaskBtn.style.display = 'none'; headerTitle.textContent = 'Analytics'; renderAnalytics(); }
        function renderAnalytics() { let totalCompletions = 0; const dayCounts = { 'Su': 0, 'Mo': 0, 'Tu': 0, 'We': 0, 'Th': 0, 'Fr': 0, 'Sa': 0 }; tasks.forEach(task => { Object.keys(task.completedOn).forEach(dateStr => { if (task.completedOn[dateStr]) { totalCompletions++; const d = new Date(dateStr); const dayOfWeek = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'][d.getUTCDay()]; dayCounts[dayOfWeek]++; } }); }); const mostProductiveDay = Object.keys(dayCounts).reduce((a, b) => dayCounts[a] > dayCounts[b] ? a : b); document.getElementById('totalCompletedStat').textContent = totalCompletions; document.getElementById('productiveDayStat').textContent = totalCompletions > 0 ? mostProductiveDay : '-'; const trendData = calculateCompletionTrend(14); renderLineChart(trendData); }
        function calculateCompletionTrend(numDays) { const labels = []; const data = new Array(numDays).fill(0); for (let i = numDays - 1; i >= 0; i--) { const d = new Date(); d.setUTCHours(0, 0, 0, 0); d.setDate(d.getDate() - i); const dateString = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`; labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })); tasks.forEach(task => { if (task.completedOn[dateString] === true) { data[numDays - 1 - i]++; } }); } return { labels, data }; }
        function renderLineChart(chartData) { const ctx = document.getElementById('completionTrendChart').getContext('2d'); if (completionTrendChart) completionTrendChart.destroy(); completionTrendChart = new Chart(ctx, { type: 'line', data: { labels: chartData.labels, datasets: [{ label: 'Tasks Completed', data: chartData.data, backgroundColor: 'rgba(0, 0, 0, 0.1)', borderColor: '#000000', borderWidth: 2, tension: 0.1, fill: true }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); }
        function exportData() { const dataStr = JSON.stringify(tasks, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); const today = new Date().toISOString().slice(0, 10); link.download = `tasks-backup-${today}.json`; link.href = url; link.click(); URL.revokeObjectURL(url); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const importedData = JSON.parse(e.target.result); if (!isValidTaskData(importedData)) { throw new Error('Invalid or corrupted data file.'); } const isConfirmed = confirm('This will overwrite all your current tasks on the server. Are you sure?'); if (isConfirmed) { tasks = importedData.map(t => ({ ...t, id: t.id || generateUUID() })); syncTasksToServer(); alert('Data imported successfully and will be synced!'); showTasksView(); } } catch (error) { alert(`Error importing data: ${error.message}`); } finally { importFileInput.value = ''; } }; reader.readAsText(file); }
        function isValidTaskData(data) { if (!Array.isArray(data)) return false; if (data.length > 0) { const firstItem = data[0]; return 'text' in firstItem && 'recurrence' in firstItem && 'completedOn' in firstItem; } return true; }
        
        // --- CORE APP LOGIC ---
        function updateView() { const dateInfo = getDateInfo(currentDisplayDate); currentDateElement.textContent = dateInfo.formatted; renderTasks(); }
        function getDateInfo(date) { const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa']; const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']; const dayOfWeek = days[date.getDay()]; const day = date.getDate(); const month = months[date.getMonth()]; const year = date.getFullYear(); const today = new Date(); today.setHours(0, 0, 0, 0); const compareDate = new Date(date); compareDate.setHours(0, 0, 0, 0); const isToday = compareDate.getTime() === today.getTime(); let formattedDate = `${dayOfWeek}, ${month} ${day}`; if (!isToday) { formattedDate += `, ${year}`; } else { formattedDate += " (Today)"; } const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; return { dayOfWeek, dateString, formatted: formattedDate }; }
        function renderTasks() { const { dayOfWeek, dateString } = getDateInfo(currentDisplayDate); taskList.innerHTML = ''; const groupedTasks = {}; const tasksForDay = tasks.filter(task => task.recurrence.includes('Daily') || task.recurrence.includes(dayOfWeek)); if (tasksForDay.length === 0) { taskList.innerHTML = '<p style="text-align:center; color:#888; margin-top:2rem;">No tasks for this day.</p>'; return; } tasksForDay.forEach(task => { const group = task.group || 'Ungrouped'; if (!groupedTasks[group]) groupedTasks[group] = []; groupedTasks[group].push(task); }); Object.keys(groupedTasks).sort((a, b) => a === 'Ungrouped' ? 1 : b === 'Ungrouped' ? -1 : a.localeCompare(b)).forEach(group => { const groupHeader = document.createElement('li'); groupHeader.className = 'group-header'; groupHeader.textContent = group; if (group !== 'Ungrouped' && group !== 'App Features' && group !== 'Welcome') { groupHeader.classList.add('deletable'); groupHeader.dataset.group = group; } taskList.appendChild(groupHeader); groupedTasks[group].forEach(task => { const li = document.createElement('li'); li.className = `task-item ${task.completedOn[dateString] ? 'completed' : ''}`; li.dataset.taskId = task.id; let habitHTML = ''; if (task.habitTracker) { const count = task.habitTracker.completedDates.length; const goal = task.habitTracker.goal; if (count >= 90) { habitHTML = `<span class="habit-formed">✔️ Habit Formed</span>`; } else { habitHTML = `<span class="habit-tracker" data-task-id="${task.id}">${count}/${goal}</span>`; } } li.innerHTML = `<input type="checkbox" class="task-checkbox" ${task.completedOn[dateString] ? 'checked' : ''}><span class="task-text">${task.text}</span><div class="task-meta">${habitHTML}</div>`; li.querySelector('.task-checkbox').addEventListener('change', e => { e.stopPropagation(); toggleTaskCompletion(task.id, dateString); }); li.addEventListener('click', e => { if (e.target.type !== 'checkbox' && !e.target.classList.contains('habit-tracker')) { openEditModal(task); } }); taskList.appendChild(li); }); }); }
        function toggleTaskCompletion(taskId, dateString) { const task = tasks.find(t => t.id === taskId); if (!task) return; if(task.completedOn[dateString] === undefined) { task.completedOn[dateString] = true; } else { task.completedOn[dateString] = !task.completedOn[dateString]; } if (task.habitTracker) { const isCompletedNow = task.completedOn[dateString]; const dateIndex = task.habitTracker.completedDates.indexOf(dateString); if (isCompletedNow && dateIndex === -1) { task.habitTracker.completedDates.push(dateString); } else if (!isCompletedNow && dateIndex > -1) { task.habitTracker.completedDates.splice(dateIndex, 1); } const count = task.habitTracker.completedDates.length; const currentGoal = task.habitTracker.goal; if (isCompletedNow && count === currentGoal) { if (currentGoal === 21) task.habitTracker.goal = 45; else if (currentGoal === 45) task.habitTracker.goal = 90; } } syncTasksToServer(); renderTasks(); }
        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        function populateGroupDropdown() { const existingGroups = [...new Set(tasks.map(task => task.group).filter(g => g && g !== 'App Features' && g !== 'Welcome'))]; groupSelect.innerHTML = '<option value="">Ungrouped</option>'; existingGroups.sort().forEach(group => { groupSelect.innerHTML += `<option value="${group}">${group}</option>` }); groupSelect.innerHTML += '<option value="--add-new--">Create New Group...</option>'; }
        function openTaskModal() { taskModal.style.display = 'flex'; taskInput.focus(); populateGroupDropdown(); }
        function closeTaskModal() { taskModal.style.display = 'none'; taskInput.value = ''; editingTaskId = null; deleteBtn.style.display = 'none'; document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected')); newGroupInput.style.display = 'none'; newGroupInput.value = ''; groupSelect.value = ''; }
        function openEditModal(task) { editingTaskId = task.id; taskInput.value = task.text; document.querySelectorAll('.day-btn').forEach(btn => btn.classList.toggle('selected', task.recurrence.includes(btn.dataset.day))); deleteBtn.style.display = 'inline-block'; openTaskModal(); groupSelect.value = task.group || ''; if(task.group === 'App Features' || task.group === 'Welcome') { deleteBtn.style.display = 'none'; } }
        function openHabitGoalModal(taskId) { editingHabitTaskId = taskId; const task = tasks.find(t => t.id === taskId); if (!task) return; habitGoalInput.value = task.habitTracker.goal; habitInfoText.textContent = `Current progress for "${task.text}" is ${task.habitTracker.completedDates.length} days.`; habitGoalModal.style.display = 'flex'; habitGoalInput.focus(); }
        function closeHabitGoalModal() { habitGoalModal.style.display = 'none'; habitGoalInput.value = ''; editingHabitTaskId = null; }
        function saveHabitGoal() { const task = tasks.find(t => t.id === editingHabitTaskId); if (!task) return; const newGoal = parseInt(habitGoalInput.value, 10); const currentCount = task.habitTracker.completedDates.length; if (isNaN(newGoal) || newGoal <= 0) { alert("Please enter a valid positive number for the goal."); return; } if (newGoal < currentCount) { alert(`The new goal must be >= your current progress of ${currentCount} days.`); return; } task.habitTracker.goal = newGoal; syncTasksToServer(); closeHabitGoalModal(); updateView(); }
        function saveTask() { const text = taskInput.value.trim(); const selectedDays = Array.from(document.querySelectorAll('.day-btn.selected')).map(btn => btn.dataset.day); if (!text || selectedDays.length === 0) { alert('Task text and at least one day are required.'); return; } let group = null; if (groupSelect.value === '--add-new--') { group = newGroupInput.value.trim() || null; } else { group = groupSelect.value || null; } if (editingTaskId) { const task = tasks.find(t => t.id === editingTaskId); if(task) { task.text = text; task.group = group; task.recurrence = selectedDays; } } else { const newTask = { id: generateUUID(), text, group, recurrence: selectedDays, completedOn: {}, habitTracker: { goal: 21, completedDates: [] } }; tasks.push(newTask); } syncTasksToServer(); closeTaskModal(); updateView(); }
        function deleteTask() { if (editingTaskId) { tasks = tasks.filter(t => t.id !== editingTaskId); syncTasksToServer(); closeTaskModal(); updateView(); } }
        function _deleteGroup(groupName) { tasks.forEach(task => { if (task.group === groupName) { task.group = null; } }); syncTasksToServer(); updateView(); }
        function openDeleteGroupModal(groupName) { groupToDelete = groupName; deleteGroupModalText.textContent = `Delete the "${groupName}" group? All tasks inside will be moved to Ungrouped.`; deleteGroupModal.style.display = 'flex'; }
        function closeDeleteGroupModal() { deleteGroupModal.style.display = 'none'; groupToDelete = null; }

        // --- EVENT LISTENERS ---
        headerTitle.addEventListener('click', () => { if (tasksContainer.style.display !== 'none') { showAnalyticsView(); } else { showTasksView(); } }); addTaskBtn.addEventListener('click', () => { editingTaskId = null; taskInput.value = ''; deleteBtn.style.display = 'none'; openTaskModal(); }); prevDayBtn.addEventListener('click', () => { currentDisplayDate.setDate(currentDisplayDate.getDate() - 1); updateView(); }); nextDayBtn.addEventListener('click', () => { currentDisplayDate.setDate(currentDisplayDate.getDate() + 1); updateView(); }); currentDateElement.addEventListener('click', () => { currentDisplayDate = new Date(); updateView(); }); cancelBtn.addEventListener('click', closeTaskModal); saveBtn.addEventListener('click', saveTask); deleteBtn.addEventListener('click', deleteTask); taskList.addEventListener('click', e => { if (e.target.classList.contains('group-header') && e.target.classList.contains('deletable')) { openDeleteGroupModal(e.target.dataset.group); } if (e.target.classList.contains('habit-tracker')) { e.stopPropagation(); const taskId = e.target.dataset.taskId; openHabitGoalModal(taskId); } }); saveHabitGoalBtn.addEventListener('click', saveHabitGoal); cancelHabitGoalBtn.addEventListener('click', closeHabitGoalModal); cancelDeleteGroupBtn.addEventListener('click', closeDeleteGroupModal); confirmDeleteGroupBtn.addEventListener('click', () => { if (groupToDelete) { _deleteGroup(groupToDelete); } closeDeleteGroup_Modal(); }); groupSelect.addEventListener('change', () => { if (groupSelect.value === '--add-new--') { newGroupInput.style.display = 'block'; newGroupInput.focus(); } else { newGroupInput.style.display = 'none'; } }); daysSelection.addEventListener('click', e => { if (e.target.classList.contains('day-btn')) { if (e.target.dataset.day === 'Daily') { const isSelected = e.target.classList.contains('selected'); document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected')); if (!isSelected) { e.target.classList.add('selected'); } } else { document.querySelector('.day-btn[data-day="Daily"]').classList.remove('selected'); e.target.classList.toggle('selected'); } } }); exportBtn.addEventListener('click', exportData); importBtn.addEventListener('click', () => importFileInput.click()); importFileInput.addEventListener('change', importData); logoutBtn.addEventListener('click', handleLogout);

        // --- INITIAL LOAD ---
        welcomeMessage.textContent = `Logged in as {{ username }}.`;
        showTasksView();
    </script>
</body>
</html>