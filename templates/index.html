<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE ONE V3 - Tasks</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <!-- Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO client library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Google Fonts for the old paper style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nothing+You+Could+Do&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Custom Properties for an Old Paper Theme --- */
        :root {
            --bg-color: #FDFBF5;
            /* A creamy, parchment-like background */
            --primary-text-color: #4B3F34;
            /* Dark brown for text, like old ink */
            --secondary-text-color: #796A5D;
            /* A lighter, faded brown */
            --border-color: #D3C6B5;
            /* A subtle, aged border color */
            --card-bg-color: rgba(253, 251, 245, 0.8);
            /* Slightly transparent to show texture */
            --accent-color: #5D4037;
            /* A deeper brown for accents */
            --accent-color-inverted: #FDFBF5;
            --danger-color: #8D2A2A;
            /* A muted, blood-red for danger */
            --danger-hover-bg: #7B2424;
            --danger-text-color: #FDFBF5;

            /* --- Progress Bar Colors --- */
            --progress-bar-bg: rgba(121, 106, 93, 0.1);
            --progress-fill: #5D4037;


            /* --- Font & Border Styles --- */
            --font-main: 'Nothing You Could Do', cursive;
            /* The handwritten font */
            --border-radius-md: 5px;
            --border-radius-lg: 8px;

            /* --- Shadows & Textures --- */
            --shadow-light: 3px 3px 5px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 5px 5px 10px rgba(0, 0, 0, 0.15);
            --text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1);
            --transition-fast: all 0.2s ease-in-out;
        }

        /* --- General Resets & Body --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Old Paper Background Effect */
        body {
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            min-height: 100vh;
            padding: 1rem;
            display: flex;
            justify-content: center;
            /* Texture overlay */
            background-image:
                linear-gradient(rgba(220, 205, 185, 0.15) 1px, transparent 1px),
                linear-gradient(90deg, rgba(220, 205, 185, 0.15) 1px, transparent 1px),
                radial-gradient(ellipse at center, rgba(169, 140, 112, 0.2), transparent 70%);
            background-size: 20px 20px, 20px 20px, 100% 100%;
        }

        /* --- Main Layout & Header --- */
        .container {
            max-width: 650px;
            width: 100%;
            background-image:
                repeating-linear-gradient(to bottom,
                    transparent 0,
                    transparent 23px,
                    var(--border-color) 24px);
            background-color: var(--bg-color);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-heavy), inset 0 0 40px rgba(0, 0, 0, 0.08);
            border-radius: 3px 2px 5px 2px;
            line-height: 24px;
            /* Aligns text with the lines */
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .header-top h1 {
            font-size: 3.5rem;
            font-weight: 400;
            color: var(--primary-text-color);
            text-shadow: var(--text-shadow);
            cursor: pointer;
            user-select: none;
            padding: 0.25rem 0.75rem;
        }

        .date-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-arrow {
            font-size: 2.5rem;
            font-weight: 400;
            color: var(--secondary-text-color);
            cursor: pointer;
            padding: 0 0.5rem;
            transition: var(--transition-fast);
            user-select: none;
        }

        .nav-arrow:hover {
            color: var(--primary-text-color);
            transform: scale(1.1);
        }

        header .date {
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--secondary-text-color);
            min-width: 210px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }

        header .date:hover {
            color: var(--primary-text-color);
        }

        /* --- Progress Bar --- */
        .progress-container {
            width: 100%;
            max-width: 400px;
            height: 15px;
            background-color: var(--progress-bar-bg);
            border-radius: var(--border-radius-md);
            margin: 2rem auto;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .progress-bar-inner {
            height: 100%;
            width: 0;
            background-color: var(--progress-fill);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            font-weight: 400;
            color: var(--primary-text-color);
            opacity: 0.9;
            user-select: none;
            text-shadow: none;
        }

        /* --- Analytics & Data Cards --- */
        .analytics-container {
            padding-top: 1rem;
        }

        .analytics-section {
            margin-bottom: 2rem;
        }

        .analytics-section h2 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 1rem;
            color: var(--primary-text-color);
            padding-left: 0.5rem;
            border-left: 2px solid var(--accent-color);
        }

        .chart-container,
        .stat-card,
        .data-management-card {
            background: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            margin-bottom: 1.5rem;
            backdrop-filter: blur(2px);
            /* Adds to the layered look */
        }

        .chart-container h2,
        .data-management-card h2 {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            color: var(--secondary-text-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            position: relative;
            transition: var(--transition-fast);
            padding: 1.25rem;
            text-align: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        .stat-card .value {
            font-size: 3rem;
            font-weight: 400;
            color: var(--primary-text-color);
            line-height: 1;
        }

        .stat-card .label {
            font-size: 1.1rem;
            color: var(--secondary-text-color);
            margin-top: 0.5rem;
            font-weight: 400;
        }

        .stat-card .sublabel {
            font-size: 0.9rem;
            color: var(--secondary-text-color);
            opacity: 0.7;
            margin-top: 0.25rem;
        }


        .welcome-message {
            text-align: center;
            font-size: 1.2rem;
            color: var(--secondary-text-color);
            margin-bottom: 1.5rem;
        }

        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        /* --- BUTTON STYLING --- */
        .data-actions button,
        .modal-actions button {
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--primary-text-color);
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: var(--border-radius-md);
            transition: var(--transition-fast);
            text-align: center;
            text-shadow: none;
            box-shadow: var(--shadow-light);
        }

        .data-actions button:not(.btn-danger):hover,
        .modal-actions button:not(.btn-danger):hover {
            background-color: var(--accent-color);
            color: var(--accent-color-inverted);
            border-color: var(--accent-color);
            box-shadow: var(--shadow-heavy);
        }

        .btn-danger {
            background-color: transparent;
            color: var(--danger-color) !important;
            border-color: var(--danger-color) !important;
        }

        .btn-danger:hover {
            background-color: var(--danger-hover-bg) !important;
            border-color: var(--danger-hover-bg) !important;
            color: var(--danger-text-color) !important;
        }

        /* --- FLOATING ACTION BUTTON (Wax Seal) --- */
        .add-task-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            background: var(--danger-color);
            /* Wax color */
            color: var(--accent-color-inverted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-family: serif;
            /* A more formal plus */
            font-weight: 700;
            line-height: 1;
            cursor: pointer;
            transition: var(--transition-fast);
            z-index: 999;
            border: 2px solid #A53A3A;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.3), inset 0px 0px 5px rgba(255, 255, 255, 0.2);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .add-task-btn:hover {
            transform: scale(1.08) rotate(5deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            background: var(--danger-hover-bg);
        }


        /* --- Modal & Forms --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(75, 63, 52, 0.3);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--bg-color);
            background-image:
                repeating-linear-gradient(to bottom,
                    transparent 0,
                    transparent 23px,
                    var(--border-color) 24px);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy), inset 0 0 40px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--accent-color);
            line-height: 24px;
        }


        .modal-content input[type="text"],
        .modal-content input[type="number"],
        .modal-content select {
            width: 100%;
            padding: 0.5rem 0.5rem;
            margin-bottom: 1rem;
            border: none;
            border-bottom: 1px dashed var(--border-color);
            font-size: 1.5rem;
            border-radius: 0;
            transition: var(--transition-fast);
            background: transparent;
            -webkit-appearance: none;
            appearance: none;
            color: var(--primary-text-color);
        }

        .modal-content input::placeholder {
            color: var(--secondary-text-color);
            opacity: 0.7;
        }

        .modal-content input[type="text"]:focus,
        .modal-content input[type="number"]:focus,
        .modal-content select:focus {
            border-bottom: 1px solid var(--accent-color);
            outline: none;
        }

        .days-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .day-btn {
            padding: 0.75rem 0.25rem;
            border: 1px solid var(--border-color);
            background: transparent;
            cursor: pointer;
            text-align: center;
            font-size: 1.1rem;
            border-radius: var(--border-radius-md);
            transition: var(--transition-fast);
            color: var(--secondary-text-color);
        }

        .day-btn.selected {
            background: var(--accent-color);
            color: var(--accent-color-inverted);
            border-color: var(--accent-color);
        }


        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .modal-actions button {
            flex: 1;
            white-space: nowrap;
        }

        /* --- Task List --- */
        .task-list {
            list-style: none;
        }

        .group-header {
            font-size: 1.5rem;
            font-weight: 400;
            padding: 1.5rem 0 0.75rem 0;
            margin-top: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--secondary-text-color);
        }

        .group-header.deletable:hover {
            color: var(--primary-text-color);
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.5rem;
            border-bottom: 1px dotted rgba(121, 106, 93, 0.2);
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
            min-height: 48px;
            /* 2 lines of text */
        }

        .task-item:hover {
            background: rgba(189, 174, 159, 0.1);
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: var(--secondary-text-color);
            opacity: 0.8;
        }

        /* --- OLD SCHOOL CHECKBOX --- */
        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--secondary-text-color);
            border-radius: 2px;
            position: relative;
            margin-right: 1rem;
            cursor: pointer;
            appearance: none;
            transition: var(--transition-fast);
            flex-shrink: 0;
            background: transparent;
        }

        .task-checkbox:hover {
            border-color: var(--primary-text-color);
        }

        .task-checkbox:checked {
            background: transparent;
            border-color: var(--accent-color);
        }

        /* The hand-drawn 'X' */
        .task-checkbox:checked::before {
            content: 'X';
            font-family: sans-serif;
            font-weight: bold;
            font-size: 22px;
            color: var(--accent-color);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -52%);
        }

        .task-text {
            flex-grow: 1;
            font-size: 1.4rem;
            font-weight: 400;
            word-break: break-word;
            margin-right: 0.5rem;
            transition: color 0.2s ease;
            line-height: 1.5;
            /* For better readability with cursive */
        }


        .task-item.missed-yesterday .task-text {
            color: var(--danger-color);
        }

        .task-item.missed-yesterday.completed .task-text {
            color: var(--secondary-text-color);
        }

        /* --- Habit Tracker Tags --- */
        .task-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .habit-tracker,
        .habit-formed {
            font-size: 1rem;
            background-color: transparent;
            color: var(--secondary-text-color);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            transition: var(--transition-fast);
        }

        .habit-tracker:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-text-color);
        }

        .habit-formed {
            border-color: #A3B9A3;
            color: #4B6E4B;
        }

        *:focus,
        *:focus-visible,
        button:focus,
        input:focus,
        select:focus,
        textarea:focus,
        a:focus,
        div:focus,
        span:focus {
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        /* Remove webkit tap highlight on mobile */
        * {
            -webkit-tap-highlight-color: transparent !important;
            -webkit-focus-ring-color: transparent !important;
        }
    </style>
</head>

<body>
    <!-- Data div for initial tasks -->
    <div id="initial-data" data-tasks='{{ initial_tasks | tojson }}' style="display: none;"></div>

    <div class="container">
        <header>
            <div class="header-top">
                <h1 id="headerTitle">Tasks</h1>
            </div>
            <div class="date-nav">
                <span class="nav-arrow" id="prevDayBtn">‹</span>
                <div class="date" id="currentDate"></div>
                <span class="nav-arrow" id="nextDayBtn">›</span>
            </div>
        </header>

        <!-- Progress Bar Element -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-inner" id="progressBarInner"></div>
            <span class="progress-text" id="progressText"></span>
        </div>

        <div id="tasksContainer">
            <ul class="task-list" id="taskList"></ul>
        </div>

        <div id="analyticsContainer" style="display: none;">
            <!-- Motivation & Progress Analytics -->
            <div class="analytics-section">
                <h2>Motivation & Progress</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="currentStreakStat">0</div>
                        <div class="label">Current Streak</div>
                        <div class="sublabel">days of completion</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="bestStreakStat">0</div>
                        <div class="label">Best Streak</div>
                        <div class="sublabel">personal record</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="weeklyCompletionStat">0%</div>
                        <div class="label">Weekly Rate</div>
                        <div class="sublabel">last 7 days</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="consistencyScoreStat">0%</div>
                        <div class="label">Consistency</div>
                        <div class="sublabel">regularity score</div>
                    </div>
                </div>
            </div>

            <!-- Productivity Insights -->
            <div class="analytics-section">
                <h2>Productivity Insights</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="peakDayStat">-</div>
                        <div class="label">Peak Day</div>
                        <div class="sublabel">most productive</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="taskDifficultyStat">-</div>
                        <div class="label">Hardest Task</div>
                        <div class="sublabel">most skipped</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="momentumStat">0%</div>
                        <div class="label">Momentum</div>
                        <div class="sublabel">task completion flow</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="averageCompletionStat">0</div>
                        <div class="label">Daily Average</div>
                        <div class="sublabel">tasks per day</div>
                    </div>
                </div>
            </div>

            <!-- Goal-Oriented Metrics -->
            <div class="analytics-section">
                <h2>Goal Progress</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="monthlyImprovementStat">0%</div>
                        <div class="label">Monthly Growth</div>
                        <div class="sublabel">vs last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="categoryPerformanceStat">-</div>
                        <div class="label">Best Category</div>
                        <div class="sublabel">highest completion</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="weeklyGoalsStat">0%</div>
                        <div class="label">Weekly Goals</div>
                        <div class="sublabel">planned vs actual</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="totalHabitsStat">0</div>
                        <div class="label">Active Habits</div>
                        <div class="sublabel">in progress</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="chart-container">
                <h2>Completion Trends</h2>
                <canvas id="completionTrendChart"></canvas>
            </div>

            <div class="chart-container">
                <h2>Weekly Performance</h2>
                <canvas id="weeklyPerformanceChart"></canvas>
            </div>

            <!-- Data Management -->
            <div class="data-management-card">
                <h2>Data & Account</h2>
                <div class="welcome-message" id="welcomeMessage"></div>
                <div class="data-actions">
                    <button id="importBtn">Import Data</button>
                    <button id="exportBtn">Export Data</button>
                    <button id="logoutBtn" class="btn-danger">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="add-task-btn" id="addTaskBtn">+</div>

    <!-- Modals and Inputs -->
    <input type="file" id="importFileInput" style="display: none;" accept="application/json">
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <input type="text" id="taskInput" placeholder="Scribe thy task...">
            <select id="groupSelect"></select>
            <input type="text" id="newGroupInput" placeholder="A new chapter..." style="display: none;">
            <div class="days-selection" id="daysSelection">
                <button class="day-btn" data-day="Daily">Daily</button><button class="day-btn" data-day="Mo">Mo</button><button class="day-btn" data-day="Tu">Tu</button><button class="day-btn" data-day="We">We</button><button class="day-btn" data-day="Th">Th</button><button class="day-btn" data-day="Fr">Fr</button><button class="day-btn" data-day="Sa">Sa</button><button class="day-btn" data-day="Su">Su</button>
            </div>
            <div class="modal-actions">
                <button class="btn-danger" id="deleteBtn" style="display: none;">Banish Task</button><button id="cancelBtn">Cancel</button><button id="saveBtn">Save</button>
            </div>
        </div>
    </div>
    <div class="modal" id="deleteGroupModal">
        <div class="modal-content">
            <p id="deleteGroupModalText" style="font-size:1.3rem; text-align:center;"></p>
            <div class="modal-actions">
                <button id="cancelDeleteGroupBtn">Cancel</button><button id="confirmDeleteGroupBtn" class="btn-danger">Confirm Banishment</button>
            </div>
        </div>
    </div>
    <div class="modal" id="habitGoalModal">
        <div class="modal-content">
            <h3 style="font-weight: 400; font-size: 1.5rem; margin-bottom: 0.75rem; text-align:center;">Set Habit Goal</h3>
            <p id="habitInfoText" style="color: #666; margin-bottom: 1.5rem; font-size: 1.2rem; text-align:center;"></p>
            <label for="habitGoalInput" style="font-size: 1.2rem; margin-bottom: 0.5rem; display: block; text-align: left;">Goal (in days):</label>
            <input type="number" id="habitGoalInput" placeholder="e.g., 21" min="1">
            <div class="modal-actions">
                <button id="cancelHabitGoalBtn">Cancel</button><button id="saveHabitGoalBtn">Save Goal</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const headerTitle = document.getElementById('headerTitle');
        const tasksContainer = document.getElementById('tasksContainer');
        const analyticsContainer = document.getElementById('analyticsContainer');
        const taskList = document.getElementById('taskList');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const dateNav = document.querySelector('.date-nav');
        const currentDateElement = document.getElementById('currentDate');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const taskModal = document.getElementById('taskModal');
        const taskInput = document.getElementById('taskInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const daysSelection = document.getElementById('daysSelection');
        const groupSelect = document.getElementById('groupSelect');
        const newGroupInput = document.getElementById('newGroupInput');
        const deleteGroupModal = document.getElementById('deleteGroupModal');
        const deleteGroupModalText = document.getElementById('deleteGroupModalText');
        const cancelDeleteGroupBtn = document.getElementById('cancelDeleteGroupBtn');
        const confirmDeleteGroupBtn = document.getElementById('confirmDeleteGroupBtn');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFileInput = document.getElementById('importFileInput');
        const habitGoalModal = document.getElementById('habitGoalModal');
        const habitInfoText = document.getElementById('habitInfoText');
        const habitGoalInput = document.getElementById('habitGoalInput');
        const saveHabitGoalBtn = document.getElementById('saveHabitGoalBtn');
        const cancelHabitGoalBtn = document.getElementById('cancelHabitGoalBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBarInner = document.getElementById('progressBarInner');
        const progressText = document.getElementById('progressText');

        // State
        const initialDataEl = document.getElementById('initial-data');
        let tasks = JSON.parse(initialDataEl.dataset.tasks);
        let currentDisplayDate = new Date();
        let editingTaskId = null;
        let editingHabitTaskId = null;
        let groupToDelete = null;
        let completionTrendChart = null;
        let weeklyPerformanceChart = null;

        // --- REAL-TIME SERVER COMMUNICATION (WebSocket) ---
        const socket = io();
        let isSyncing = false;
        let syncTimeout;

        socket.on('tasks_updated', (updatedTasks) => {
            console.log('Received real-time task update from server.');
            tasks = updatedTasks;
            if (tasksContainer.style.display !== 'none') {
                renderTasks();
                updateProgressBar();
            }
        });

        socket.on('connect', () => {
            console.log('WebSocket connected!');
        });
        socket.on('disconnect', () => {
            console.log('WebSocket disconnected.');
        });

        async function syncTasksToServer() {
            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(async () => {
                if (isSyncing) return;
                isSyncing = true;
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(tasks)
                    });
                    if (!response.ok) throw new Error('Sync failed');
                } catch (error) {
                    console.error("Failed to sync tasks:", error);
                    alert("Connection error: Could not save your changes.");
                } finally {
                    isSyncing = false;
                }
            }, 200);
        }
        async function handleLogout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed.');
                }
            } catch (error) {
                alert('Could not connect to the server to log out.');
            }
        }

        // --- VIEW SWITCHING, ANALYTICS, DATA-MGMT ---
        function showTasksView() {
            tasksContainer.style.display = 'block';
            analyticsContainer.style.display = 'none';
            dateNav.style.visibility = 'visible';
            progressContainer.style.display = 'block';
            addTaskBtn.style.display = 'flex';
            headerTitle.textContent = 'Daily Tasks';
            updateView();
        }

        function showAnalyticsView() {
            tasksContainer.style.display = 'none';
            analyticsContainer.style.display = 'block';
            dateNav.style.visibility = 'hidden';
            progressContainer.style.display = 'none';
            addTaskBtn.style.display = 'none';
            headerTitle.textContent = 'My Chronicle';
            renderAnalytics();
        }

        function renderAnalytics() {
            const analytics = calculateComprehensiveAnalytics();

            // Motivation & Progress Analytics
            document.getElementById('currentStreakStat').textContent = analytics.currentStreak;
            document.getElementById('bestStreakStat').textContent = analytics.bestStreak;
            document.getElementById('weeklyCompletionStat').textContent = analytics.weeklyCompletion + '%';
            document.getElementById('consistencyScoreStat').textContent = analytics.consistencyScore + '%';

            // Productivity Insights
            document.getElementById('peakDayStat').textContent = analytics.peakDay;
            document.getElementById('taskDifficultyStat').textContent = analytics.hardestTask;
            document.getElementById('momentumStat').textContent = analytics.momentum + '%';
            document.getElementById('averageCompletionStat').textContent = analytics.dailyAverage;

            // Goal-Oriented Metrics
            document.getElementById('monthlyImprovementStat').textContent = analytics.monthlyImprovement + '%';
            document.getElementById('categoryPerformanceStat').textContent = analytics.bestCategory;
            document.getElementById('weeklyGoalsStat').textContent = analytics.weeklyGoals + '%';
            document.getElementById('totalHabitsStat').textContent = analytics.activeHabits;

            // Render charts
            const trendData = calculateCompletionTrend(14);
            renderLineChart(trendData);
            renderWeeklyPerformanceChart(analytics.weeklyData);
        }

        // --- ANALYTICS CALCULATIONS (UNCHANGED LOGIC) ---
        function calculateCompletionTrend(numDays) {
            const labels = [];
            const data = [];
            for (let i = numDays - 1; i >= 0; i--) {
                const d = new Date();
                d.setUTCHours(0, 0, 0, 0);
                d.setDate(d.getDate() - i);
                const dateString = formatDateString(d);
                labels.push(d.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                }));
                const dayTasks = getTasksForDate(d);
                const completedTasks = dayTasks.filter(task => task.completedOn[dateString] === true);
                const percentage = dayTasks.length > 0 ? Math.round((completedTasks.length / dayTasks.length) * 100) : 0;
                data.push(percentage);
            }
            return {
                labels,
                data
            };
        }

        function calculateComprehensiveAnalytics() {
            return {
                currentStreak: calculateCurrentStreak(),
                bestStreak: calculateBestStreak(),
                weeklyCompletion: calculateWeeklyCompletion(),
                consistencyScore: calculateConsistencyScore(),
                peakDay: calculatePeakDay(),
                hardestTask: calculateHardestTask(),
                momentum: calculateMomentum(),
                dailyAverage: calculateDailyAverage(),
                monthlyImprovement: calculateMonthlyImprovement(),
                bestCategory: calculateBestCategory(),
                weeklyGoals: calculateWeeklyGoals(),
                activeHabits: calculateActiveHabits(),
                weeklyData: calculateWeeklyData()
            };
        }

        function calculateCurrentStreak() {
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateString = formatDateString(checkDate);
                const dayTasks = getTasksForDate(checkDate);
                if (dayTasks.length === 0) continue;
                const completedTasks = dayTasks.filter(task => task.completedOn[dateString] === true);
                if (completedTasks.length === dayTasks.length && dayTasks.length > 0) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateBestStreak() {
            let bestStreak = 0;
            let currentStreak = 0;
            for (let i = 364; i >= 0; i--) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                const dateString = formatDateString(checkDate);
                const dayTasks = getTasksForDate(checkDate);
                if (dayTasks.length === 0) continue;
                const completedTasks = dayTasks.filter(task => task.completedOn[dateString] === true);
                if (completedTasks.length === dayTasks.length && dayTasks.length > 0) {
                    currentStreak++;
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }
            return bestStreak;
        }

        function calculateWeeklyCompletion() {
            let totalTasks = 0;
            let completedTasks = 0;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                const dayTasks = getTasksForDate(checkDate);
                totalTasks += dayTasks.length;
                completedTasks += dayTasks.filter(task => task.completedOn[formatDateString(checkDate)] === true).length;
            }
            return totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        }

        function calculateConsistencyScore() {
            let daysWithTasks = 0;
            let daysCompleted = 0;
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                const dayTasks = getTasksForDate(checkDate);
                if (dayTasks.length > 0) {
                    daysWithTasks++;
                    if (dayTasks.some(task => task.completedOn[formatDateString(checkDate)] === true)) {
                        daysCompleted++;
                    }
                }
            }
            return daysWithTasks > 0 ? Math.round((daysCompleted / daysWithTasks) * 100) : 0;
        }

        function calculatePeakDay() {
            const dayCounts = {
                'Su': 0,
                'Mo': 0,
                'Tu': 0,
                'We': 0,
                'Th': 0,
                'Fr': 0,
                'Sa': 0
            };
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            tasks.forEach(task => {
                Object.keys(task.completedOn).forEach(dateStr => {
                    if (task.completedOn[dateStr]) {
                        const d = new Date(dateStr);
                        const dayOfWeek = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'][d.getUTCDay()];
                        dayCounts[dayOfWeek]++;
                    }
                });
            });
            const peakDay = Object.keys(dayCounts).reduce((a, b) => dayCounts[a] > dayCounts[b] ? a : b);
            const dayIndex = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].indexOf(peakDay);
            return dayCounts[peakDay] > 0 ? dayNames[dayIndex] : '-';
        }


        function calculateHardestTask() {
            let hardestTask = '-';
            let lowestCompletion = 100;
            tasks.forEach(task => {
                const opportunities = getTasksForDate(new Date()).filter(t => t.id === task.id).length > 0 ?
                    Object.keys(task.completedOn).length : 0;
                if (opportunities < 5) return;
                const completions = Object.values(task.completedOn).filter(Boolean).length;
                const completionRate = (completions / opportunities) * 100;
                if (completionRate < lowestCompletion) {
                    lowestCompletion = completionRate;
                    hardestTask = task.text.length > 15 ? task.text.substring(0, 15) + '...' : task.text;
                }
            });
            return hardestTask;
        }


        function calculateMomentum() {
            const todayTasks = getTasksForDate(new Date());
            if (todayTasks.length === 0) return 0;
            const completedToday = todayTasks.filter(task => task.completedOn[formatDateString(new Date())] === true).length;
            return Math.round((completedToday / todayTasks.length) * 100);
        }

        function calculateDailyAverage() {
            let totalCompleted = 0;
            let daysCount = 0;
            const uniqueDates = new Set(tasks.flatMap(t => Object.keys(t.completedOn)));
            if (uniqueDates.size === 0) return 0;
            tasks.forEach(task => {
                totalCompleted += Object.values(task.completedOn).filter(Boolean).length;
            });
            return Math.round(totalCompleted / uniqueDates.size) || 0;
        }

        function calculateMonthlyImprovement() {
            const thisMonth = calculateMonthCompletion(0);
            const lastMonth = calculateMonthCompletion(1);
            if (lastMonth === 0) return thisMonth > 0 ? 100 : 0;
            return Math.round(((thisMonth - lastMonth) / lastMonth) * 100);
        }

        function calculateMonthCompletion(monthsAgo) {
            let totalTasks = 0,
                completedTasks = 0;
            const today = new Date();
            const targetMonth = new Date(today.getFullYear(), today.getMonth() - monthsAgo, 1);
            const month = targetMonth.getMonth();
            const year = targetMonth.getFullYear();
            tasks.forEach(task => {
                Object.keys(task.completedOn).forEach(dateStr => {
                    const d = new Date(dateStr);
                    if (d.getMonth() === month && d.getFullYear() === year) {
                        const {
                            dayOfWeek
                        } = getDateInfo(d);
                        if (task.recurrence.includes('Daily') || task.recurrence.includes(dayOfWeek)) {
                            totalTasks++;
                            if (task.completedOn[dateStr]) completedTasks++;
                        }
                    }
                });
            });
            return totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        }


        function calculateBestCategory() {
            const categoryStats = {};
            tasks.forEach(task => {
                const category = task.group || 'Ungrouped';
                if (!categoryStats[category]) categoryStats[category] = {
                    total: 0,
                    completed: 0
                };
                Object.keys(task.completedOn).forEach(dateStr => {
                    categoryStats[category].total++;
                    if (task.completedOn[dateStr]) categoryStats[category].completed++;
                });
            });
            let bestCategory = '-';
            let bestRate = -1;
            Object.keys(categoryStats).forEach(cat => {
                const rate = categoryStats[cat].total > 0 ? (categoryStats[cat].completed / categoryStats[cat].total) : 0;
                if (rate > bestRate) {
                    bestRate = rate;
                    bestCategory = cat;
                }
            });
            return bestCategory;
        }

        function calculateWeeklyGoals() {
            return calculateWeeklyCompletion();
        }

        function calculateActiveHabits() {
            return tasks.filter(task => task.habitTracker && task.habitTracker.goal > 0).length;
        }

        function calculateWeeklyData() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const data = [];
            let today = new Date();
            let dayOfWeek = today.getDay();
            if (dayOfWeek === 0) dayOfWeek = 7; // Sunday is 7

            for (let i = 1; i <= 7; i++) {
                let dayData = 0;
                const checkDate = new Date();
                checkDate.setDate(today.getDate() - (dayOfWeek - i));
                const dateString = formatDateString(checkDate);
                const dayTasks = getTasksForDate(checkDate);
                if (dayTasks.length > 0) {
                    const completed = dayTasks.filter(t => t.completedOn[dateString]).length;
                    dayData = Math.round((completed / dayTasks.length) * 100);
                }
                data.push(dayData);
            }

            return {
                labels: days,
                data
            };
        }

        // --- CHART RENDERING (with Old Paper Theme) ---
        function renderLineChart(chartData) {
            const ctx = document.getElementById('completionTrendChart').getContext('2d');
            if (completionTrendChart) completionTrendChart.destroy();

            completionTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Completion %',
                        data: chartData.data,
                        backgroundColor: 'rgba(93, 64, 55, 0.1)',
                        borderColor: '#5D4037',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#5D4037',
                        pointBorderColor: '#FDFBF5',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#796A5D',
                                font: {
                                    family: "'Nothing You Could Do', cursive",
                                    size: 14
                                },
                                callback: value => value + '%'
                            },
                            grid: {
                                color: 'rgba(121, 106, 93, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#796A5D',
                                font: {
                                    family: "'Nothing You Could Do', cursive",
                                    size: 14
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#FDFBF5',
                            titleColor: '#4B3F34',
                            bodyColor: '#4B3F34',
                            borderColor: '#D3C6B5',
                            borderWidth: 1,
                            titleFont: {
                                family: "'Nothing You Could Do', cursive"
                            },
                            bodyFont: {
                                family: "'Nothing You Could Do', cursive"
                            },
                            callbacks: {
                                label: context => context.parsed.y + '% completed'
                            }
                        }
                    }
                }
            });
        }

        function renderWeeklyPerformanceChart(weeklyData) {
            const ctx = document.getElementById('weeklyPerformanceChart').getContext('2d');
            if (weeklyPerformanceChart) weeklyPerformanceChart.destroy();

            weeklyPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeklyData.labels,
                    datasets: [{
                        label: 'Completion %',
                        data: weeklyData.data,
                        backgroundColor: [
                            'rgba(141, 42, 42, 0.6)',
                            'rgba(93, 64, 55, 0.6)',
                            'rgba(121, 106, 93, 0.6)',
                            'rgba(141, 42, 42, 0.6)',
                            'rgba(93, 64, 55, 0.6)',
                            'rgba(121, 106, 93, 0.6)',
                            'rgba(141, 42, 42, 0.6)'
                        ],
                        borderColor: '#5D4037',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#796A5D',
                                font: {
                                    family: "'Nothing You Could Do', cursive",
                                    size: 14
                                },
                                callback: value => value + '%'
                            },
                            grid: {
                                color: 'rgba(121, 106, 93, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#796A5D',
                                font: {
                                    family: "'Nothing You Could Do', cursive",
                                    size: 14
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#FDFBF5',
                            titleColor: '#4B3F34',
                            bodyColor: '#4B3F34',
                            borderColor: '#D3C6B5',
                            borderWidth: 1,
                            titleFont: {
                                family: "'Nothing You Could Do', cursive"
                            },
                            bodyFont: {
                                family: "'Nothing You Could Do', cursive"
                            },
                            callbacks: {
                                label: context => context.parsed.y + '% completed'
                            }
                        }
                    }
                }
            });
        }


        // --- DATA I/O ---
        function exportData() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataBlob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            const today = new Date().toISOString().slice(0, 10);
            link.download = `tasks-backup-${today}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!isValidTaskData(importedData)) {
                        throw new Error('Invalid or corrupted data file.');
                    }
                    const isConfirmed = confirm('This will overwrite all your current tasks on the server. Are you sure?');
                    if (isConfirmed) {
                        tasks = importedData.map(t => ({ ...t,
                            id: t.id || generateUUID()
                        }));
                        syncTasksToServer();
                        alert('Data imported successfully and will be synced!');
                        showTasksView();
                    }
                } catch (error) {
                    alert(`Error importing data: ${error.message}`);
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        function isValidTaskData(data) {
            if (!Array.isArray(data)) return false;
            if (data.length > 0) {
                const firstItem = data[0];
                return 'text' in firstItem && 'recurrence' in firstItem && 'completedOn' in firstItem;
            }
            return true;
        }

        // --- CORE APP LOGIC ---
        function updateView() {
            const dateInfo = getDateInfo(currentDisplayDate);
            currentDateElement.textContent = dateInfo.formatted;
            renderTasks();
            updateProgressBar();
        }

        function getDateInfo(date) {
            const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const dayOfWeek = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const compareDate = new Date(date);
            compareDate.setHours(0, 0, 0, 0);
            const isToday = compareDate.getTime() === today.getTime();
            let formattedDate = `${dayOfWeek}, ${month} ${day}`;
            if (!isToday) {
                formattedDate += `, ${year}`;
            } else {
                formattedDate += " (Today)";
            }
            const dateString = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            return {
                dayOfWeek,
                dateString,
                formatted: formattedDate,
                isToday
            };
        }

        function updateProgressBar() {
            const dateInfo = getDateInfo(currentDisplayDate);
            const tasksForDay = getTasksForDate(currentDisplayDate);
            if (tasksForDay.length === 0) {
                progressContainer.style.display = 'none';
                return;
            }
            progressContainer.style.display = 'block';
            const completedTasks = tasksForDay.filter(task => task.completedOn[dateInfo.dateString] === true);
            const percentage = tasksForDay.length > 0 ? Math.round((completedTasks.length / tasksForDay.length) * 100) : 0;
            progressBarInner.style.width = `${percentage}%`;
            progressText.textContent = `${completedTasks.length} of ${tasksForDay.length} done`;
        }

        function findMostRecentPreviousDueDate(task, currentDate) {
            let checkDate = new Date(currentDate);
            checkDate.setDate(checkDate.getDate() - 1); // Start from yesterday
            for (let i = 0; i < 365; i++) {
                const {
                    dayOfWeek
                } = getDateInfo(checkDate);
                const isScheduled = task.recurrence.includes('Daily') || task.recurrence.includes(dayOfWeek);
                if (isScheduled) {
                    return checkDate;
                }
                checkDate.setDate(checkDate.getDate() - 1);
            }
            return null;
        }

        function renderTasks() {
            const dateInfo = getDateInfo(currentDisplayDate);
            const {
                dayOfWeek,
                dateString,
                isToday
            } = dateInfo;
            taskList.innerHTML = '';
            const groupedTasks = {};
            const tasksForDay = getTasksForDate(currentDisplayDate);

            if (tasksForDay.length === 0) {
                taskList.innerHTML = '<p style="text-align:center; color:#888; margin-top:2rem; font-size:1.3rem;">No tasks for this day.</p>';
                return;
            }

            tasksForDay.forEach(task => {
                const group = task.group || 'Ungrouped';
                if (!groupedTasks[group]) groupedTasks[group] = [];
                groupedTasks[group].push(task);
            });

            Object.keys(groupedTasks).sort((a, b) => a === 'Ungrouped' ? 1 : b === 'Ungrouped' ? -1 : a.localeCompare(b)).forEach(group => {
                const groupHeader = document.createElement('li');
                groupHeader.className = 'group-header';
                groupHeader.textContent = group;
                if (group !== 'Ungrouped') {
                    groupHeader.classList.add('deletable');
                    groupHeader.dataset.group = group;
                }
                taskList.appendChild(groupHeader);
                groupedTasks[group].forEach(task => {
                    const isCompletedToday = task.completedOn[dateString] === true;
                    const li = document.createElement('li');
                    li.className = 'task-item';
                    if (isCompletedToday) li.classList.add('completed');
                    li.dataset.taskId = task.id;
                    if (isToday && !isCompletedToday) {
                        const previousDueDate = findMostRecentPreviousDueDate(task, currentDisplayDate);
                        if (previousDueDate) {
                            const {
                                dateString: prevDateString
                            } = getDateInfo(previousDueDate);
                            if (task.completedOn[prevDateString] === false || task.completedOn[prevDateString] === undefined) {
                                li.classList.add('missed-yesterday');
                            }
                        }
                    }
                    let habitHTML = '';
                    if (task.habitTracker) {
                        const count = task.habitTracker.completedDates.length;
                        const goal = task.habitTracker.goal;
                        if (count >= 90) {
                            habitHTML = `<span class="habit-formed">✔️ Habit Formed</span>`;
                        } else if (goal > 0) {
                            habitHTML = `<span class="habit-tracker" data-task-id="${task.id}">${count}/${goal}</span>`;
                        }
                    }
                    li.innerHTML = `<input type="checkbox" class="task-checkbox" ${isCompletedToday ? 'checked' : ''}><span class="task-text">${task.text}</span><div class="task-meta">${habitHTML}</div>`;
                    li.querySelector('.task-checkbox').addEventListener('change', e => {
                        e.stopPropagation();
                        toggleTaskCompletion(task.id, dateString);
                    });
                    li.addEventListener('click', e => {
                        if (e.target.type !== 'checkbox' && !e.target.classList.contains('habit-tracker')) {
                            openEditModal(task);
                        }
                    });
                    taskList.appendChild(li);
                });
            });
        }

        function toggleTaskCompletion(taskId, dateString) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            task.completedOn[dateString] = !task.completedOn[dateString];
            if (task.habitTracker) {
                const isCompletedNow = task.completedOn[dateString];
                const dateIndex = task.habitTracker.completedDates.indexOf(dateString);
                if (isCompletedNow && dateIndex === -1) {
                    task.habitTracker.completedDates.push(dateString);
                } else if (!isCompletedNow && dateIndex > -1) {
                    task.habitTracker.completedDates.splice(dateIndex, 1);
                }
            }
            syncTasksToServer();
            renderTasks();
            updateProgressBar();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function populateGroupDropdown() {
            const existingGroups = [...new Set(tasks.map(task => task.group).filter(g => g))];
            groupSelect.innerHTML = '<option value="">Ungrouped</option>';
            existingGroups.sort().forEach(group => {
                groupSelect.innerHTML += `<option value="${group}">${group}</option>`
            });
            groupSelect.innerHTML += '<option value="--add-new--">Create New Group...</option>';
        }

        function openTaskModal() {
            taskModal.style.display = 'flex';
            taskInput.focus();
            populateGroupDropdown();
        }

        function closeTaskModal() {
            taskModal.style.display = 'none';
            taskInput.value = '';
            editingTaskId = null;
            deleteBtn.style.display = 'none';
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));
            newGroupInput.style.display = 'none';
            newGroupInput.value = '';
            groupSelect.value = '';
        }

        function openEditModal(task) {
            editingTaskId = task.id;
            taskInput.value = task.text;
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.toggle('selected', task.recurrence.includes(btn.dataset.day)));
            deleteBtn.style.display = 'inline-block';
            openTaskModal();
            groupSelect.value = task.group || '';
        }

        function openHabitGoalModal(taskId) {
            editingHabitTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            habitGoalInput.value = task.habitTracker.goal;
            habitInfoText.textContent = `Current progress for "${task.text}" is ${task.habitTracker.completedDates.length} days.`;
            habitGoalModal.style.display = 'flex';
            habitGoalInput.focus();
        }

        function closeHabitGoalModal() {
            habitGoalModal.style.display = 'none';
            habitGoalInput.value = '';
            editingHabitTaskId = null;
        }

        function saveHabitGoal() {
            const task = tasks.find(t => t.id === editingHabitTaskId);
            if (!task) return;
            const newGoal = parseInt(habitGoalInput.value, 10);
            const currentCount = task.habitTracker.completedDates.length;
            if (isNaN(newGoal) || newGoal <= 0) {
                alert("Please enter a valid positive number for the goal.");
                return;
            }
            if (newGoal < currentCount) {
                alert(`The new goal must be >= your current progress of ${currentCount} days.`);
                return;
            }
            task.habitTracker.goal = newGoal;
            syncTasksToServer();
            closeHabitGoalModal();
            updateView();
        }

        function saveTask() {
            const text = taskInput.value.trim();
            const selectedDays = Array.from(document.querySelectorAll('.day-btn.selected')).map(btn => btn.dataset.day);
            if (!text || selectedDays.length === 0) {
                alert('Task text and at least one day are required.');
                return;
            }
            let group = null;
            if (groupSelect.value === '--add-new--') {
                group = newGroupInput.value.trim() || null;
            } else {
                group = groupSelect.value || null;
            }
            if (editingTaskId) {
                const task = tasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.text = text;
                    task.group = group;
                    task.recurrence = selectedDays;
                }
            } else {
                const newTask = {
                    id: generateUUID(),
                    text,
                    group,
                    recurrence: selectedDays,
                    completedOn: {},
                    habitTracker: {
                        goal: 21,
                        completedDates: []
                    }
                };
                tasks.push(newTask);
            }
            syncTasksToServer();
            closeTaskModal();
            updateView();
        }

        function deleteTask() {
            if (editingTaskId) {
                tasks = tasks.filter(t => t.id !== editingTaskId);
                syncTasksToServer();
                closeTaskModal();
                updateView();
            }
        }

        function _deleteGroup(groupName) {
            tasks.forEach(task => {
                if (task.group === groupName) {
                    task.group = null;
                }
            });
            syncTasksToServer();
            updateView();
        }

        function openDeleteGroupModal(groupName) {
            groupToDelete = groupName;
            deleteGroupModalText.textContent = `Banish the "${groupName}" chapter? All tasks within shall be moved to the Ungrouped section.`;
            deleteGroupModal.style.display = 'flex';
        }

        function closeDeleteGroupModal() {
            deleteGroupModal.style.display = 'none';
            groupToDelete = null;
        }

        // --- EVENT LISTENERS ---
        headerTitle.addEventListener('click', () => {
            if (analyticsContainer.style.display === 'none') {
                showAnalyticsView();
            } else {
                showTasksView();
            }
        });
        addTaskBtn.addEventListener('click', () => {
            editingTaskId = null;
            taskInput.value = '';
            deleteBtn.style.display = 'none';
            openTaskModal();
        });
        prevDayBtn.addEventListener('click', () => {
            currentDisplayDate.setDate(currentDisplayDate.getDate() - 1);
            updateView();
        });
        nextDayBtn.addEventListener('click', () => {
            currentDisplayDate.setDate(currentDisplayDate.getDate() + 1);
            updateView();
        });
        currentDateElement.addEventListener('click', () => {
            currentDisplayDate = new Date();
            updateView();
        });
        cancelBtn.addEventListener('click', closeTaskModal);
        saveBtn.addEventListener('click', saveTask);
        deleteBtn.addEventListener('click', deleteTask);
        taskList.addEventListener('click', e => {
            if (e.target.classList.contains('group-header') && e.target.classList.contains('deletable')) {
                openDeleteGroupModal(e.target.dataset.group);
            }
            if (e.target.classList.contains('habit-tracker')) {
                e.stopPropagation();
                const taskId = e.target.dataset.taskId;
                openHabitGoalModal(taskId);
            }
        });
        saveHabitGoalBtn.addEventListener('click', saveHabitGoal);
        cancelHabitGoalBtn.addEventListener('click', closeHabitGoalModal);
        cancelDeleteGroupBtn.addEventListener('click', closeDeleteGroupModal);
        confirmDeleteGroupBtn.addEventListener('click', () => {
            if (groupToDelete) {
                _deleteGroup(groupToDelete);
            }
            closeDeleteGroupModal();
        });
        groupSelect.addEventListener('change', () => {
            if (groupSelect.value === '--add-new--') {
                newGroupInput.style.display = 'block';
                newGroupInput.focus();
            } else {
                newGroupInput.style.display = 'none';
            }
        });
        daysSelection.addEventListener('click', e => {
            if (e.target.classList.contains('day-btn')) {
                if (e.target.dataset.day === 'Daily') {
                    const isSelected = e.target.classList.contains('selected');
                    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));
                    if (!isSelected) {
                        e.target.classList.add('selected');
                    }
                } else {
                    document.querySelector('.day-btn[data-day="Daily"]').classList.remove('selected');
                    e.target.classList.toggle('selected');
                }
            }
        });
        exportBtn.addEventListener('click', exportData);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importData);
        logoutBtn.addEventListener('click', handleLogout);

        // --- CLICK OUTSIDE TO CLOSE MODALS ---
        taskModal.addEventListener('click', (e) => {
            if (e.target === taskModal) {
                closeTaskModal();
            }
        });
        deleteGroupModal.addEventListener('click', (e) => {
            if (e.target === deleteGroupModal) {
                closeDeleteGroupModal();
            }
        });
        habitGoalModal.addEventListener('click', (e) => {
            if (e.target === habitGoalModal) {
                closeHabitGoalModal();
            }
        });

        // --- INITIAL LOAD ---
        welcomeMessage.textContent = `Logged in as {{ username }}.`;
        showTasksView();
    </script>
</body>

</html>
