<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAJORA - Notes</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='notes.css') }}">
</head>
<body class="notes-page-active">
    <div class="container">
        <header>
            <div class="header-top">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='favicon.png') }}" alt="Yajora Logo" class="logo">
                    <div id="appDropdown" class="dropdown-content">
                        <a href="/~">Yajora Tasks</a>
                        <a href="/notes">Yajora Notes</a>
                    </div>
                </div>
                <h1 id="headerTitle">Notes</h1>
            </div>
        </header>

        <div id="notesContainer" class="notes-grid">
            <!-- Notes will be dynamically inserted here -->
        </div>

    </div>

    <!-- Floating Action Button -->
    <div class="add-task-btn" id="addNoteBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>

    <!-- Note Inspector Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content" id="noteModalContent">
            <!-- This content will be dynamically generated by JS -->
        </div>
    </div>

    <!-- New Note Creation Modal -->
    <div class="modal" id="createNoteModal">
        <div class="modal-content-create">
            <h2>Create a New Note</h2>
            <form id="createNoteForm">
                <div class="form-group">
                    <label for="newNoteTitle">Title</label>
                    <input type="text" id="newNoteTitle" placeholder="Enter a title for your note" required>
                </div>
                <div class="form-group">
                    <label for="newNoteContent">Content (Markdown supported)</label>
                    <textarea id="newNoteContent" rows="10" placeholder="What's on your mind?"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelCreateBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const notesContainer = document.getElementById('notesContainer');
            const addNoteBtn = document.getElementById('addNoteBtn');
            const noteModal = document.getElementById('noteModal');
            const createNoteModal = document.getElementById('createNoteModal');
            const createNoteForm = document.getElementById('createNoteForm');
            const cancelCreateBtn = document.getElementById('cancelCreateBtn');
            const appDropdown = document.getElementById('appDropdown');
            const logo = document.querySelector('.logo');

            // State
            let notes = [];
            let editingNoteId = null;
            let currentTags = [];

            // --- API Communication ---
            const api = {
                getNotes: async () => (await fetch('/api/notes')).json(),
                createNote: async (title, content) => (await fetch('/api/notes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content }) })).json(),
                updateNote: async (id, title, content, tags) => (await fetch(`/api/notes/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content, tags }) })).json(),
                deleteNote: async (id) => (await fetch(`/api/notes/${id}`, { method: 'DELETE' })).json(),
            };

            // --- Main Note Grid Rendering ---
            function renderNotes() {
                notesContainer.innerHTML = '';
                if (notes.length === 0) {
                    notesContainer.innerHTML = '<p style="text-align:center; color:#888; grid-column: 1 / -1;">You have no notes yet. Click the + button to create one!</p>';
                    return;
                }
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.dataset.noteId = note.id;

                    let cardContent = '';
                    switch (note.note_type) {
                        case 'Movie':
                        case 'TV Show':
                            card.classList.add('movie-card');
                            const details = note.metadata?.details;
                            const posterPath = details?.poster_path;
                            const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w500${posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                            const title = details?.title || details?.name || note.title;
                            const releaseDate = details?.release_date || details?.first_air_date;
                            const year = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
                            cardContent = `
                                <img src="${posterUrl}" alt="Poster for ${title}" class="note-card-poster" loading="lazy">
                                <div class="note-card-overlay">
                                    <h3 class="note-card-title">${title}</h3>
                                    <p class="note-card-meta">${year}</p>
                                </div>`;
                            break;
                        case 'Wikipedia':
                            card.classList.add('wikipedia-card');
                            cardContent = `
                                <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/Wikipedia-logo-v2.svg" alt="Wikipedia Logo" class="wikipedia-logo">
                                <h3 class="note-card-title">${note.metadata?.details?.title || note.title}</h3>`;
                            break;
                        case 'YouTube':
                             card.classList.add('youtube-card');
                             const videoId = note.metadata?.video_id;
                             const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 'https://via.placeholder.com/500x281.png?text=No+Thumbnail';
                             cardContent = `
                                <img src="${thumbnailUrl}" alt="YouTube Thumbnail" class="youtube-thumbnail" loading="lazy">
                                <div class="youtube-overlay">
                                </div>
                                <div class="play-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                </div>`;
                            break;
                        case 'Reddit':
                            card.classList.add('reddit-card-grid');
                            const redditDetails = note.metadata?.details;
                            const subreddit = note.metadata?.subreddit;
                            if (redditDetails) {
                                cardContent = `
                                    <div class="reddit-card-grid-top">
                                        <img src="/static/Reddit_Logo.webp" alt="Reddit Snoo" class="snoo-logo-grid">
                                    </div>
                                    <div class="reddit-card-grid-bottom">
                                        <h3 class="note-card-title">${redditDetails.title}</h3>
                                        <p class="reddit-subreddit-grid">r/${subreddit}</p>
                                    </div>
                                `;
                            } else {
                                cardContent = `
                                    <h3 class="note-card-title">${note.title}</h3>
                                    <div class="note-card-content">Could not load Reddit post.</div>
                                `;
                            }
                            break;
                        case 'X':
                            card.classList.add('x-card-grid');
                            const xDetails = note.metadata?.details;
                            if (xDetails) {
                                cardContent = `
                                    <div class="x-card-grid-top">
                                        <img src="/static/x-logo.png" alt="X Logo" class="x-logo-grid">
                                    </div>
                                    <div class="x-card-grid-bottom">
                                        <h3 class="note-card-title">Tweet by @${xDetails.author_name}</h3>
                                    </div>
                                `;
                            } else {
                                cardContent = `
                                    <h3 class="note-card-title">${note.title}</h3>
                                    <div class="note-card-content">Could not load X post.</div>
                                `;
                            }
                            break;
                        default: // Standard Note
                            cardContent = `
                                <h3 class="note-card-title">${note.title}</h3>
                                <div class="note-card-content">${marked.parse(note.content || '')}</div>`;
                            break;
                    }
                    card.innerHTML = cardContent;
                    notesContainer.appendChild(card);
                });
            }

            // --- Helper function to calculate relative time ---
            function timeAgo(dateString) {
                const now = new Date();
                const past = new Date(dateString);
                const diffMs = now - past;
                const diffSeconds = Math.floor(diffMs / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);
                const diffWeeks = Math.floor(diffDays / 7);
                const diffMonths = Math.floor(diffDays / 30);
                const diffYears = Math.floor(diffDays / 365);

                if (diffSeconds < 60) return 'just now';
                if (diffMinutes < 60) return diffMinutes === 1 ? '1 minute ago' : `${diffMinutes} minutes ago`;
                if (diffHours < 24) return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
                if (diffDays < 7) return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
                if (diffWeeks < 4) return diffWeeks === 1 ? '1 week ago' : `${diffWeeks} weeks ago`;
                if (diffMonths < 12) return diffMonths === 1 ? '1 month ago' : `${diffMonths} months ago`;
                return diffYears === 1 ? '1 year ago' : `${diffYears} years ago`;
            }

            // --- NEW: Inspector Modal Builder ---
            let saveTimeout;
            function debouncedSave() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    if (editingNoteId) handleSaveNote();
                }, 500);
            }

            function openNoteModal(note) {
                editingNoteId = note ? note.id : null;
                currentTags = note ? (note.tags || []) : [];
                const modalContent = document.getElementById('noteModalContent');
                modalContent.innerHTML = ''; // Clear previous content

                // Create main layout
                const mainContent = document.createElement('div');
                mainContent.className = 'modal-main-content';

                const sidebar = document.createElement('div');
                sidebar.className = 'modal-sidebar';

                // --- Populate Main Content (Left Panel) ---
                let mainContentHTML = '';
                let url = null;
                let useDefaultSidebar = true; // Flag to control sidebar generation

                switch (note.note_type) {
                    case 'Movie':
                    case 'TV Show':
                        const posterPath = note.metadata?.details?.poster_path;
                        const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w780${posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                        url = note.metadata?.details?.id ? `https://www.themoviedb.org/${note.note_type === 'Movie' ? 'movie' : 'tv'}/${note.metadata.details.id}` : note.metadata?.url;
                        mainContentHTML = `
                            <div class="media-preview-container">
                                <img src="${posterUrl}" loading="lazy" class="media-poster-preview" alt="Poster">
                                ${url ? `<a href="${url}" target="_blank" class="view-details-btn">View Details</a>` : ''}
                            </div>
                        `;
                        break;
                    case 'Wikipedia':
                        url = note.metadata?.url;
                        if (url) {
                            mainContent.classList.add('wikipedia-embed-content');
                            mainContentHTML = `
                                <div class="media-preview-container">
                                    <iframe src="${url}" frameborder="0"></iframe>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">No Wikipedia URL found for this note.</div>`;
                        }
                        break;
                    case 'YouTube':
                        const videoId = note.metadata?.video_id;
                        url = videoId ? `https://www.youtube.com/watch?v=${videoId}` : null;
                        if (videoId) {
                            mainContent.classList.add('youtube-video-content');
                            mainContentHTML = `
                                <div class="media-preview-container">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">No video ID found for this note.</div>`;
                        }
                        break;
                    case 'Reddit':
                        const redditDetails = note.metadata?.details;
                        url = redditDetails?.url;
                        if (redditDetails) {
                            mainContent.classList.add('reddit-card-content');
                            const subreddit = note.metadata?.subreddit;
                            mainContentHTML = `
                                <div class="reddit-card-custom">
                                    <div class="reddit-card-top">
                                        <img src="/static/Reddit_Logo.webp" alt="Reddit Snoo" class="snoo-logo">
                                    </div>
                                    <div class="reddit-card-bottom">
                                        <div class="reddit-logo-text">reddit</div>
                                        <h3 class="reddit-post-title">${redditDetails.title}</h3>
                                        <p class="reddit-subreddit">r/${subreddit}</p>
                                        <a href="${url}" target="_blank" class="reddit-view-btn">VIEW ON REDDIT</a>
                                    </div>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">Could not load Reddit post.</div>`;
                        }
                        break;
                    case 'X':
                        const xDetails = note.metadata?.details;
                        url = xDetails?.url;
                        if (xDetails) {
                            mainContent.classList.add('x-card-content');
                            mainContentHTML = `
                                <div class="x-card-custom">
                                    <div class="x-card-top">
                                        <img src="/static/x-logo.png" alt="X Logo" class="x-logo">
                                    </div>
                                    <div class="x-card-middle">
                                        <div class="x-logo-text">x</div>
                                        <h3 class="x-post-title">Tweet by @${xDetails.author_name}</h3>
                                    </div>
                                    <div class="x-card-bottom">
                                        <a href="${url}" target="_blank" class="x-view-btn">VIEW ON X</a>
                                    </div>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">Could not load X post.</div>`;
                        }
                        break;
                    default:
                        mainContentHTML = `<div class="content-preview">${marked.parse(note.content || 'No content.')}</div>`;
                        break;
                }
                mainContent.innerHTML = mainContentHTML;

                // --- Populate Sidebar (Right Panel) ---
                if (useDefaultSidebar) {
                    const title = note.metadata?.details?.title || note.metadata?.details?.name || note.title;
                    const tldr = note.metadata?.details?.overview || note.metadata?.details?.summary || 'No summary available.';
                    
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <h2 class="title">${title}</h2>
                            <p class="meta">
                                <span class="date">${timeAgo(note.created_at)}</span>
                                ${url ? `<a href="${url}" target="_blank" class="source-link"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="15,3 21,3 21,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="10" y1="14" x2="21" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> ${note.note_type === 'Movie' || note.note_type === 'TV Show' ? 'TMDB' : note.note_type}</a>` : `<span class="source">${note.note_type === 'Movie' || note.note_type === 'TV Show' ? 'TMDB' : note.note_type}</span>`}
                            </p>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">TLDR</h3>
                            <p class="tldr-content">${tldr}</p>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">MIND TAGS</h3>
                            <div class="tags-container">
                                <!-- Tags will be rendered here -->
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">
                                MIND NOTES <span class="question-mark" title="Your personal notes. Saved automatically.">?</span>
                            </h3>
                            <textarea id="mindNotesInput" placeholder="Type here to add a note...">${note.content || ''}</textarea>
                        </div>

                        <div class="sidebar-footer">
                            <button class="action-btn" id="deleteNoteBtn" title="Delete Note">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    `;
                }

                modalContent.appendChild(mainContent);
                modalContent.appendChild(sidebar);
                renderTags();

                // Add auto-save for mind notes
                const mindNotesInput = document.getElementById('mindNotesInput');
                if (mindNotesInput) {
                    mindNotesInput.addEventListener('input', debouncedSave);
                    mindNotesInput.addEventListener('blur', () => {
                        clearTimeout(saveTimeout);
                        handleSaveNote();
                    });
                }

                // Add event listener for adding tags
                const tagsContainer = document.querySelector('.tags-container');
                tagsContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.add-tag-btn')) {
                        // Toggle the visibility of the input controls
                        const controls = document.querySelector('.add-tag-controls');
                        if (controls) {
                            controls.remove();
                        } else {
                            const tagsRow = document.querySelector('.tags-row');
                            if (tagsRow) {
                                const newControls = document.createElement('div');
                                newControls.className = 'add-tag-controls';
                                newControls.innerHTML = `
                                    <input type="text" class="add-tag-input" placeholder="Add a tag...">
                                    <button class="add-tag-plus-btn"><svg viewBox="0 0 24 24" fill="currentColor"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/></svg></button>
                                `;
                                tagsRow.parentElement.insertBefore(newControls, tagsRow);
                                const input = newControls.querySelector('.add-tag-input');
                                input.focus();
                            }
                        }
                    } else if (e.target.closest('.add-tag-plus-btn')) {
                        // Add the tag
                        const input = document.querySelector('.add-tag-input');
                        const tag = input.value.trim();
                        if (tag && !currentTags.includes(tag)) {
                            currentTags.push(tag);
                            renderTags();
                            handleSaveNote(); // Auto-save after adding tag
                        }
                    } else if (e.target.classList.contains('delete-tag')) {
                        // Delete the tag
                        const tagSpan = e.target.parentElement;
                        const tagText = tagSpan.textContent.slice(0, -1); // remove ×
                        const index = currentTags.indexOf(tagText);
                        if (index > -1) {
                            currentTags.splice(index, 1);
                            renderTags();
                            handleSaveNote(); // Auto-save after deleting tag
                        }
                    }
                });

                // Handle Enter key in input
                tagsContainer.addEventListener('keypress', (e) => {
                    if (e.target.classList.contains('add-tag-input') && e.key === 'Enter') {
                        const input = e.target;
                        const tag = input.value.trim();
                        if (tag && !currentTags.includes(tag)) {
                            currentTags.push(tag);
                            renderTags();
                            handleSaveNote(); // Auto-save after adding tag
                        }
                    }
                });

                noteModal.style.display = 'flex';
            }
            
            function closeNoteModal() {
                noteModal.style.display = 'none';
                editingNoteId = null;
                currentTags = [];
            }

            // --- Function to render tags ---
            function renderTags() {
                const tagsContainer = document.querySelector('.tags-container');
                if (!tagsContainer) return;

                const note = notes.find(n => n.id === editingNoteId);
                if (!note) return;

                const typeTagMap = {
                    'Movie': 'Movie',
                    'TV Show': 'TV Show',
                    'Wikipedia': 'Wikipedia Article',
                    'YouTube': 'YouTube Video',
                    'Reddit': 'Reddit Post',
                    'X': 'X Post',
                    'Standard': null
                };
                const typeTag = typeTagMap[note.note_type];
                const allTags = typeTag ? [typeTag, ...currentTags] : currentTags;
                const existingControls = document.querySelector('.add-tag-controls');
                const isControlsVisible = existingControls && !existingControls.classList.contains('hidden');
                tagsContainer.innerHTML = `
                    ${isControlsVisible ? `<div class="add-tag-controls">
                        <input type="text" class="add-tag-input" placeholder="Add a tag...">
                        <button class="add-tag-plus-btn"><svg viewBox="0 0 24 24" fill="currentColor"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"/></svg></button>
                    </div>` : ''}
                    <div class="tags-row">
                        <button class="add-tag-btn">+ Add tag</button>
                        ${allTags.map((tag, index) => {
                            const isTypeTag = typeTag && index === 0;
                            return `<span class="tag${isTypeTag ? '' : ' user-tag'}">${tag}${isTypeTag ? '' : '<span class="delete-tag">×</span>'}</span>`;
                        }).join('')}
                    </div>
                `;
            }

            // --- Event Handlers ---
            async function handleSaveNote() {
                const notesInput = document.getElementById('mindNotesInput');
                if (!editingNoteId || !notesInput) return;

                const noteToUpdate = notes.find(n => n.id === editingNoteId);
                const title = noteToUpdate.title; // Title is not editable in this view
                const content = notesInput.value;

                try {
                    const result = await api.updateNote(editingNoteId, title, content, currentTags);
                    const index = notes.findIndex(n => n.id === editingNoteId);
                    if (index !== -1) notes[index] = result.note;
                    renderNotes(); // Refresh grid in case content changed
                    // Removed alert for auto-save
                } catch (error) {
                    console.error('Save failed:', error);
                    // Could show a subtle notification instead
                }
            }

            async function handleDeleteNote() {
                if (!editingNoteId) return;
                try {
                    await api.deleteNote(editingNoteId);
                    notes = notes.filter(n => n.id !== editingNoteId);
                    renderNotes();
                    closeNoteModal();
                } catch (error) {
                    console.error('Delete failed:', error);
                }
            }

            // --- Event Listeners ---
            addNoteBtn.addEventListener('click', openCreateModal);

            // Event delegation for modal actions
            noteModal.addEventListener('click', (e) => {
                if (e.target.closest('#cancelNoteBtn')) closeNoteModal();
                if (e.target.closest('#deleteNoteBtn')) handleDeleteNote();
                if (e.target === noteModal) closeNoteModal();
            });

            // Auto-save on blur for mind notes
            noteModal.addEventListener('blur', (e) => {
                if (e.target.id === 'mindNotesInput') {
                    handleSaveNote();
                }
            }, true);

            notesContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.note-card');
                if (card) {
                    const noteId = card.dataset.noteId;
                    const noteToEdit = notes.find(n => n.id === noteId);
                    if (noteToEdit) {
                        openNoteModal(noteToEdit);
                    }
                }
            });

            logo.addEventListener('click', (event) => {
                event.stopPropagation();
                appDropdown.style.display = appDropdown.style.display === 'block' ? 'none' : 'block';
            });
            window.addEventListener('click', () => {
                if (appDropdown.style.display === 'block') appDropdown.style.display = 'none';
            });

            // --- Create Modal Functions & Handlers ---
            function openCreateModal() {
                createNoteForm.reset(); // Clear form from previous use
                createNoteModal.style.display = 'flex';
            }

            function closeCreateModal() {
                createNoteModal.style.display = 'none';
            }

            async function handleCreateNote(e) {
                e.preventDefault(); // Prevent default form submission
                const titleInput = document.getElementById('newNoteTitle');
                const contentInput = document.getElementById('newNoteContent');
                
                const title = titleInput.value.trim();
                const content = contentInput.value.trim();

                if (!title) {
                    alert('Please enter a title for your note.');
                    return;
                }

                try {
                    const newNote = await api.createNote(title, content);
                    notes.unshift(newNote.note); // Add to the beginning of the array
                    renderNotes();
                    closeCreateModal();
                } catch (error) {
                    console.error('Create note failed:', error);
                    alert('Could not create the note. Please try again.');
                }
            }

            // --- Add listeners for create modal ---
            createNoteForm.addEventListener('submit', handleCreateNote);
            cancelCreateBtn.addEventListener('click', closeCreateModal);
            createNoteModal.addEventListener('click', (e) => {
                if (e.target === createNoteModal) {
                    closeCreateModal();
                }
            });

            // --- Initialization ---
            async function init() {
                try {
                    notes = await api.getNotes();
                    renderNotes();
                } catch (error) {
                    console.error('Initialization failed:', error);
                    notesContainer.innerHTML = '<p style="text-align:center; color:var(--danger-color);">Could not load notes.</p>';
                }
            }

            init();

            // --- Keyboard Shortcuts ---
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.code === 'KeyN') {
                    e.preventDefault();
                    openCreateModal();
                }
            });
        });
    </script>
</body>
</html>