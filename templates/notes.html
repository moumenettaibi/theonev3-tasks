<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAJORA - Notes</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='notes.css') }}">
</head>
<body class="notes-page-active">
    <div class="container">
        <header>
            <div class="header-top">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='favicon.png') }}" alt="Yajora Logo" class="logo">
                    <div id="appDropdown" class="dropdown-content">
                        <a href="/~">Yajora Tasks</a>
                        <a href="/notes">Yajora Notes</a>
                    </div>
                </div>
                <h1 id="headerTitle">Notes</h1>
            </div>
        </header>

        <div id="notesContainer" class="notes-grid">
            <!-- Notes will be dynamically inserted here -->
        </div>

    </div>

    <!-- Floating Action Button -->
    <div class="add-task-btn" id="addNoteBtn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>

    <!-- Note Inspector Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content" id="noteModalContent">
            <!-- This content will be dynamically generated by JS -->
        </div>
    </div>

    <!-- New Note Creation Modal -->
    <div class="modal" id="createNoteModal">
        <div class="modal-content-create">
            <h2>Create a New Note</h2>
            <form id="createNoteForm">
                <div class="form-group">
                    <label for="newNoteTitle">Title</label>
                    <input type="text" id="newNoteTitle" placeholder="Enter a title for your note" required>
                </div>
                <div class="form-group">
                    <label for="newNoteContent">Content (Markdown supported)</label>
                    <textarea id="newNoteContent" rows="10" placeholder="What's on your mind?"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelCreateBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const notesContainer = document.getElementById('notesContainer');
            const addNoteBtn = document.getElementById('addNoteBtn');
            const noteModal = document.getElementById('noteModal');
            const createNoteModal = document.getElementById('createNoteModal');
            const createNoteForm = document.getElementById('createNoteForm');
            const cancelCreateBtn = document.getElementById('cancelCreateBtn');
            const appDropdown = document.getElementById('appDropdown');
            const logo = document.querySelector('.logo');

            // State
            let notes = [];
            let editingNoteId = null;

            // --- API Communication ---
            const api = {
                getNotes: async () => (await fetch('/api/notes')).json(),
                createNote: async (title, content) => (await fetch('/api/notes', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content }) })).json(),
                updateNote: async (id, title, content) => (await fetch(`/api/notes/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title, content }) })).json(),
                deleteNote: async (id) => (await fetch(`/api/notes/${id}`, { method: 'DELETE' })).json(),
            };

            // --- Main Note Grid Rendering ---
            function renderNotes() {
                notesContainer.innerHTML = '';
                if (notes.length === 0) {
                    notesContainer.innerHTML = '<p style="text-align:center; color:#888; grid-column: 1 / -1;">You have no notes yet. Click the + button to create one!</p>';
                    return;
                }
                notes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.dataset.noteId = note.id;

                    let cardContent = '';
                    switch (note.note_type) {
                        case 'Movie':
                        case 'TV Show':
                            card.classList.add('movie-card');
                            const details = note.metadata?.details;
                            const posterPath = details?.poster_path;
                            const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w500${posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                            const title = details?.title || details?.name || note.title;
                            const releaseDate = details?.release_date || details?.first_air_date;
                            const year = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
                            cardContent = `
                                <img src="${posterUrl}" alt="Poster for ${title}" class="note-card-poster" loading="lazy">
                                <div class="note-card-overlay">
                                    <h3 class="note-card-title">${title}</h3>
                                    <p class="note-card-meta">${year}</p>
                                </div>`;
                            break;
                        case 'Wikipedia':
                            card.classList.add('wikipedia-card');
                            cardContent = `
                                <img src="https://upload.wikimedia.org/wikipedia/commons/8/80/Wikipedia-logo-v2.svg" alt="Wikipedia Logo" class="wikipedia-logo">
                                <h3 class="note-card-title">${note.metadata?.details?.title || note.title}</h3>`;
                            break;
                        case 'YouTube':
                             card.classList.add('youtube-card');
                             const videoId = note.metadata?.video_id;
                             const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/hqdefault.jpg` : 'https://via.placeholder.com/500x281.png?text=No+Thumbnail';
                             cardContent = `
                                <img src="${thumbnailUrl}" alt="YouTube Thumbnail" class="youtube-thumbnail" loading="lazy">
                                <div class="youtube-overlay">
                                    <h3 class="note-card-title">${note.title}</h3>
                                </div>
                                <div class="play-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                                </div>`;
                            break;
                        default: // Standard Note
                            cardContent = `
                                <h3 class="note-card-title">${note.title}</h3>
                                <div class="note-card-content">${marked.parse(note.content || '')}</div>`;
                            break;
                    }
                    card.innerHTML = cardContent;
                    notesContainer.appendChild(card);
                });
            }

            // --- NEW: Inspector Modal Builder ---
            function openNoteModal(note) {
                editingNoteId = note ? note.id : null;
                const modalContent = document.getElementById('noteModalContent');
                modalContent.innerHTML = ''; // Clear previous content

                // Create main layout
                const mainContent = document.createElement('div');
                mainContent.className = 'modal-main-content';

                const sidebar = document.createElement('div');
                sidebar.className = 'modal-sidebar';

                // --- Populate Main Content (Left Panel) ---
                let mainContentHTML = '';
                const url = note.metadata?.url;
                let useDefaultSidebar = true; // Flag to control sidebar generation

                switch (note.note_type) {
                    case 'Movie':
                    case 'TV Show':
                        const posterPath = note.metadata?.details?.poster_path;
                        const posterUrl = posterPath ? `https://image.tmdb.org/t/p/w780${posterPath}` : 'https://via.placeholder.com/500x750.png?text=No+Image';
                        mainContentHTML = `
                            <div class="media-preview-container">
                                <img src="${posterUrl}" loading="lazy" class="media-poster-preview" alt="Poster">
                                ${url ? `<a href="${url}" target="_blank" class="view-details-btn">View Details</a>` : ''}
                            </div>
                        `;
                        break;
                    case 'Wikipedia':
                        const wikipediaUrl = note.metadata?.url;
                        if (wikipediaUrl) {
                            mainContent.classList.add('wikipedia-embed-content');
                            mainContentHTML = `
                                <div class="media-preview-container">
                                    <iframe src="${wikipediaUrl}" frameborder="0"></iframe>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">No Wikipedia URL found for this note.</div>`;
                        }
                        break;
                    case 'YouTube':
                        const videoId = note.metadata?.video_id;
                        if (videoId) {
                            mainContent.classList.add('youtube-video-content');
                            mainContentHTML = `
                                <div class="media-preview-container">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            `;
                        } else {
                            mainContentHTML = `<div class="content-preview">No video ID found for this note.</div>`;
                        }
                        break;
                    default:
                        mainContentHTML = `<div class="content-preview">${marked.parse(note.content || 'No content.')}</div>`;
                        break;
                }
                mainContent.innerHTML = mainContentHTML;

                // --- Populate Sidebar (Right Panel) ---
                if (useDefaultSidebar) {
                    const title = note.metadata?.details?.title || note.metadata?.details?.name || note.title;
                    const tldr = note.metadata?.details?.overview || note.metadata?.details?.summary || 'No summary available.';
                    
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <h2 class="title">${title}</h2>
                            <p class="meta">
                                <span class="date">about 1 month ago</span> @ <span class="source">${note.note_type}</span>
                            </p>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">TLDR</h3>
                            <p class="tldr-content">${tldr}</p>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">MIND TAGS</h3>
                            <div class="tags-container">
                                <!-- Tags would be dynamically inserted here -->
                                <span class="tag">Article</span>
                                <span class="tag">Biography</span>
                                <button class="add-tag-btn">+ Add tag</button>
                            </div>
                        </div>

                        <div class="sidebar-section">
                            <h3 class="section-title">
                                MIND NOTES <span class="question-mark" title="Your personal notes. Saved automatically.">?</span>
                            </h3>
                            <textarea id="mindNotesInput" placeholder="Type here to add a note...">${note.content || ''}</textarea>
                        </div>

                        <div class="sidebar-footer">
                            <button class="action-btn" id="deleteNoteBtn" title="Delete Note">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                            <button class="action-btn" id="saveNoteBtn" title="Save Changes">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            </button>
                        </div>
                    `;
                }

                modalContent.appendChild(mainContent);
                modalContent.appendChild(sidebar);
                noteModal.style.display = 'flex';
            }
            
            function closeNoteModal() {
                noteModal.style.display = 'none';
                editingNoteId = null;
            }

            // --- Event Handlers ---
            async function handleSaveNote() {
                const notesInput = document.getElementById('mindNotesInput');
                if (!editingNoteId || !notesInput) return;

                const noteToUpdate = notes.find(n => n.id === editingNoteId);
                const title = noteToUpdate.title; // Title is not editable in this view
                const content = notesInput.value;

                try {
                    const result = await api.updateNote(editingNoteId, title, content);
                    const index = notes.findIndex(n => n.id === editingNoteId);
                    if (index !== -1) notes[index] = result.note;
                    renderNotes(); // Refresh grid in case content changed
                    alert('Note saved!');
                } catch (error) {
                    console.error('Save failed:', error);
                    alert('Could not save note.');
                }
            }

            async function handleDeleteNote() {
                if (!editingNoteId) return;
                if (confirm('Are you sure you want to delete this note?')) {
                    try {
                        await api.deleteNote(editingNoteId);
                        notes = notes.filter(n => n.id !== editingNoteId);
                        renderNotes();
                        closeNoteModal();
                    } catch (error) {
                        console.error('Delete failed:', error);
                    }
                }
            }

            // --- Event Listeners ---
            addNoteBtn.addEventListener('click', openCreateModal);

            // Event delegation for modal actions
            noteModal.addEventListener('click', (e) => {
                if (e.target.closest('#cancelNoteBtn')) closeNoteModal();
                if (e.target.closest('#saveNoteBtn')) handleSaveNote();
                if (e.target.closest('#deleteNoteBtn')) handleDeleteNote();
                if (e.target === noteModal) closeNoteModal();
            });

            notesContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.note-card');
                if (card) {
                    const noteId = card.dataset.noteId;
                    const noteToEdit = notes.find(n => n.id === noteId);
                    if (noteToEdit) {
                        openNoteModal(noteToEdit);
                    }
                }
            });

            logo.addEventListener('click', (event) => {
                event.stopPropagation();
                appDropdown.style.display = appDropdown.style.display === 'block' ? 'none' : 'block';
            });
            window.addEventListener('click', () => {
                if (appDropdown.style.display === 'block') appDropdown.style.display = 'none';
            });

            // --- Create Modal Functions & Handlers ---
            function openCreateModal() {
                createNoteForm.reset(); // Clear form from previous use
                createNoteModal.style.display = 'flex';
            }

            function closeCreateModal() {
                createNoteModal.style.display = 'none';
            }

            async function handleCreateNote(e) {
                e.preventDefault(); // Prevent default form submission
                const titleInput = document.getElementById('newNoteTitle');
                const contentInput = document.getElementById('newNoteContent');
                
                const title = titleInput.value.trim();
                const content = contentInput.value.trim();

                if (!title) {
                    alert('Please enter a title for your note.');
                    return;
                }

                try {
                    const newNote = await api.createNote(title, content);
                    notes.unshift(newNote.note); // Add to the beginning of the array
                    renderNotes();
                    closeCreateModal();
                } catch (error) {
                    console.error('Create note failed:', error);
                    alert('Could not create the note. Please try again.');
                }
            }

            // --- Add listeners for create modal ---
            createNoteForm.addEventListener('submit', handleCreateNote);
            cancelCreateBtn.addEventListener('click', closeCreateModal);
            createNoteModal.addEventListener('click', (e) => {
                if (e.target === createNoteModal) {
                    closeCreateModal();
                }
            });

            // --- Initialization ---
            async function init() {
                try {
                    notes = await api.getNotes();
                    renderNotes();
                } catch (error) {
                    console.error('Initialization failed:', error);
                    notesContainer.innerHTML = '<p style="text-align:center; color:var(--danger-color);">Could not load notes.</p>';
                }
            }

            init();
        });
    </script>
</body>
</html>