<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YAJORA - Admin Dashboard</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="admin-dashboard">
    <div class="container">
        <header>
            <div class="header-top">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='favicon.png') }}" alt="Yajora Logo" class="logo">
                    <div id="appDropdown" class="dropdown-content">
                        <a href="/~">Yajora Tasks</a>
                        <a href="/notes">Yajora Notes</a>
                        <a href="/calendar">Yajora Calendar</a>
                        <a href="/admin">Admin Dashboard</a>
                    </div>
                </div>
                <h1 id="headerTitle">Admin Dashboard</h1>
                <div class="profile-container">
                    <button id="profileBtn" class="profile-btn">
                        {% if profile_image %}
                            <img src="{{ profile_image }}" alt="Profile" class="profile-img">
                        {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                                <path d="M6 20c0-3.5 3-6 6-6s6 2.5 6 6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        {% endif %}
                    </button>
                </div>
            </div>
        </header>

        <!-- Overview Stats -->
        <div class="analytics-section">
            <h2>ðŸ“Š Platform Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value">{{ total_users }}</div>
                    <div class="label">Total Users</div>
                    <div class="sublabel">registered accounts</div>
                </div>
                <div class="stat-card">
                    <div class="value">{{ total_tasks }}</div>
                    <div class="label">Total Tasks</div>
                    <div class="sublabel">across all users</div>
                </div>
                <div class="stat-card">
                    <div class="value">{{ total_notes }}</div>
                    <div class="label">Total Notes</div>
                    <div class="sublabel">across all users</div>
                </div>
                <div class="stat-card">
                    <div class="value">{{ active_users }}</div>
                    <div class="label">Active Users</div>
                    <div class="sublabel">recent activity</div>
                </div>
            </div>
        </div>

        <!-- User Activity Charts -->
        <div class="charts-row">
            <div class="chart-container small">
                <div class="chart-header">
                    <h2>User Registrations (Last 30 Days)</h2>
                </div>
                <canvas id="userRegistrationsChart"></canvas>
            </div>

            <div class="chart-container small">
                <div class="chart-header">
                    <h2>Task Completions (Last 30 Days)</h2>
                </div>
                <canvas id="taskCompletionsChart"></canvas>
            </div>
        </div>

        <!-- Top Users -->
        <div class="analytics-section">
            <h2>ðŸ‘¥ Top Users</h2>
            <div class="charts-row">
                <div class="chart-container small">
                    <h3>Top 10 Users by Tasks</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.5rem;">Rank</th>
                                <th style="text-align: left; padding: 0.5rem;">User</th>
                                <th style="text-align: right; padding: 0.5rem;">Tasks</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in tasks_per_user %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem; font-weight: 600;">#{{ loop.index }}</td>
                                <td style="padding: 0.5rem;">{{ user.username }}</td>
                                <td style="text-align: right; padding: 0.5rem; font-weight: 600;">{{ user.task_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="chart-container small">
                    <h3>Top 10 Users by Notes</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.5rem;">Rank</th>
                                <th style="text-align: left; padding: 0.5rem;">User</th>
                                <th style="text-align: right; padding: 0.5rem;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in notes_per_user %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem; font-weight: 600;">#{{ loop.index }}</td>
                                <td style="padding: 0.5rem;">{{ user.username }}</td>
                                <td style="text-align: right; padding: 0.5rem; font-weight: 600;">{{ user.note_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Content Distribution -->
        <div class="charts-row">
            <div class="chart-container small">
                <div class="chart-header">
                    <h2>Note Types Distribution</h2>
                </div>
                <canvas id="noteTypesChart"></canvas>
            </div>

            <div class="chart-container small">
                <div class="chart-header">
                    <h2>Task Categories</h2>
                </div>
                <canvas id="taskCategoriesChart"></canvas>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-container small">
                <div class="chart-header">
                    <h2>User Engagement (Last 90 Days)</h2>
                </div>
                <canvas id="userEngagementChart"></canvas>
            </div>

            <div class="chart-container small">
                <div class="chart-header">
                    <h2>Task Completion Trends (Last 30 Days)</h2>
                </div>
                <canvas id="taskCompletionTrendsChart"></canvas>
            </div>
        </div>
        <!-- User Management Section -->
        <div class="analytics-section">
            <h2>ðŸ‘¥ User Management</h2>
            <div class="chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>All Users</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="userSearch" placeholder="Search users by name, email, tasks, notes, admin status..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; min-width: 300px;">
                        <button id="refreshUsers" style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table id="usersTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color); background: var(--background-light);">
                                <th style="text-align: left; padding: 0.75rem; font-weight: 600;">User</th>
                                <th style="text-align: left; padding: 0.75rem; font-weight: 600;">Email</th>
                                <th style="text-align: center; padding: 0.75rem; font-weight: 600;">Tasks</th>
                                <th style="text-align: center; padding: 0.75rem; font-weight: 600;">Notes</th>
                                <th style="text-align: center; padding: 0.75rem; font-weight: 600;">Admin</th>
                                <th style="text-align: center; padding: 0.75rem; font-weight: 600;">Joined</th>
                                <th style="text-align: center; padding: 0.75rem; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            {% for user in all_users %}
                            <tr style="border-bottom: 1px solid var(--border-color); cursor: pointer;" data-user='{{ user | tojson | safe }}' onclick="showUserModalFromData(this)">
                                <td style="padding: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    {% if user.profile_image %}
                                        <img src="{{ user.profile_image }}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                    {% else %}
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center;">ðŸ‘¤</div>
                                    {% endif %}
                                    <div>
                                        <div style="font-weight: 500;">{{ user.username }}</div>
                                        {% if user.oauth_provider %}
                                            <span title="{{ user.oauth_provider }}">{{ 'ðŸ”µ' if user.oauth_provider == 'google' else 'ðŸ”—' }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td style="padding: 0.75rem;">{{ user.email or 'N/A' }}</td>
                                <td style="text-align: center; padding: 0.75rem;">{{ user.task_count }}</td>
                                <td style="text-align: center; padding: 0.75rem;">{{ user.note_count }}</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    {% if user.is_admin %}
                                        <span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">ADMIN</span>
                                    {% else %}
                                        <span style="background: #9E9E9E; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">USER</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <button onclick="event.stopPropagation(); viewUserTasks('{{ user.id }}')" style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Tasks</button>
                                    <button onclick="event.stopPropagation(); viewUserNotes('{{ user.id }}')" style="padding: 0.25rem 0.5rem; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Notes</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Users Tables -->
        <div class="analytics-section">
            <h2>ðŸ“ˆ Detailed Rankings</h2>
            <div class="charts-row">
                <div class="chart-container small">
                    <h3>Tasks per User (Top 10)</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.5rem;">User</th>
                                <th style="text-align: right; padding: 0.5rem;">Tasks</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in tasks_per_user %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem;">{{ user.username }}</td>
                                <td style="text-align: right; padding: 0.5rem;">{{ user.task_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="chart-container small">
                    <h3>Notes per User (Top 10)</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.5rem;">User</th>
                                <th style="text-align: right; padding: 0.5rem;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in notes_per_user %}
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5rem;">{{ user.username }}</td>
                                <td style="text-align: right; padding: 0.5rem;">{{ user.note_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dropdown Menu Logic
        const logo = document.querySelector('.logo');
        const appDropdown = document.getElementById('appDropdown');

        logo.addEventListener('click', (event) => {
            event.stopPropagation();
            appDropdown.style.display = appDropdown.style.display === 'block' ? 'none' : 'block';
        });

        window.addEventListener('click', (event) => {
            if (!logo.contains(event.target) && appDropdown.style.display === 'block') {
                appDropdown.style.display = 'none';
            }
        });

        // Chart data from server
        const userRegistrationsData = JSON.parse('{{ user_registrations | tojson | safe }}');
        const taskCompletionsData = JSON.parse('{{ task_completions | tojson | safe }}');
        const noteTypesData = JSON.parse('{{ note_types | tojson | safe }}');
        const taskCategoriesData = JSON.parse('{{ task_categories | tojson | safe }}');
        const userEngagementData = JSON.parse('{{ user_engagement | tojson | safe }}');
        const taskCompletionTrendsData = JSON.parse('{{ task_completion_trends | tojson | safe }}');

        // Debug: Log data to console
        console.log('User Registrations Data:', userRegistrationsData);
        console.log('Task Completions Data:', taskCompletionsData);
        console.log('Note Types Data:', noteTypesData);
        console.log('Task Categories Data:', taskCategoriesData);
        console.log('User Engagement Data:', userEngagementData);
        console.log('Task Completion Trends Data:', taskCompletionTrendsData);

        // User Registrations Chart
        const userRegistrationsCtx = document.getElementById('userRegistrationsChart').getContext('2d');
        new Chart(userRegistrationsCtx, {
            type: 'line',
            data: {
                labels: userRegistrationsData.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [{
                    label: 'New Users',
                    data: userRegistrationsData.map(d => d.count),
                    borderColor: '#1a1a1a',
                    backgroundColor: 'rgba(26, 26, 26, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Task Completions Chart
        const taskCompletionsCtx = document.getElementById('taskCompletionsChart').getContext('2d');
        new Chart(taskCompletionsCtx, {
            type: 'bar',
            data: {
                labels: taskCompletionsData.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [{
                    label: 'Task Completions',
                    data: taskCompletionsData.map(d => d.completions),
                    backgroundColor: '#81C784',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Note Types Chart
        const noteTypesCtx = document.getElementById('noteTypesChart').getContext('2d');
        new Chart(noteTypesCtx, {
            type: 'doughnut',
            data: {
                labels: noteTypesData.map(d => d.note_type || 'Standard'),
                datasets: [{
                    data: noteTypesData.map(d => d.count),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: { size: 11 }
                        }
                    }
                }
            }
        });

        // Task Categories Chart
        const taskCategoriesCtx = document.getElementById('taskCategoriesChart').getContext('2d');
        new Chart(taskCategoriesCtx, {
            type: 'bar',
            data: {
                labels: taskCategoriesData.map(d => d.group),
                datasets: [{
                    label: 'Tasks',
                    data: taskCategoriesData.map(d => d.count),
                    backgroundColor: '#FFB74D',
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });

        // User Engagement Chart (90 days)
        const userEngagementCtx = document.getElementById('userEngagementChart').getContext('2d');
        new Chart(userEngagementCtx, {
            type: 'line',
            data: {
                labels: userEngagementData.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [{
                    label: 'Active Users',
                    data: userEngagementData.map(d => d.active_users),
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // Task Completion Trends Chart (30 days)
        const taskCompletionTrendsCtx = document.getElementById('taskCompletionTrendsChart').getContext('2d');
        new Chart(taskCompletionTrendsCtx, {
            type: 'bar',
            data: {
                labels: taskCompletionTrendsData.map(d => new Date(d.date).toLocaleDateString()),
                datasets: [{
                    label: 'Completed Tasks',
                    data: taskCompletionTrendsData.map(d => d.completed_tasks),
                    backgroundColor: '#2196F3',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });

        // User Management Functions
        let allUsers = [];

        async function loadUsers() {
            try {
                console.log('Loading users...');
                const response = await fetch('/api/admin/users');
                console.log('Response status:', response.status);
                if (response.ok) {
                    allUsers = await response.json();
                    console.log('Loaded users:', allUsers);
                    renderUsersTable(allUsers);
                } else {
                    console.error('Failed to load users, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid var(--border-color)';
                row.style.cursor = 'pointer';
                row.setAttribute('data-user', JSON.stringify(user));
                row.onclick = () => showUserModalFromData(row);

                const adminBadge = user.is_admin ?
                    '<span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">ADMIN</span>' :
                    '<span style="background: #9E9E9E; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">USER</span>';

                const oauthIcon = user.oauth_provider ?
                    `<span title="${user.oauth_provider}">${user.oauth_provider === 'google' ? 'ðŸ”µ' : 'ðŸ”—'}</span>` :
                    '';

                row.innerHTML = `
                    <td style="padding: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        ${user.profile_image ?
                            `<img src="${user.profile_image}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">` :
                            '<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center;">ðŸ‘¤</div>'
                        }
                        <div>
                            <div style="font-weight: 500;">${user.username}</div>
                            ${oauthIcon}
                        </div>
                    </td>
                    <td style="padding: 0.75rem;">${user.email || 'N/A'}</td>
                    <td style="text-align: center; padding: 0.75rem;">${user.task_count}</td>
                    <td style="text-align: center; padding: 0.75rem;">${user.note_count}</td>
                    <td style="text-align: center; padding: 0.75rem;">${adminBadge}</td>
                    <td style="text-align: center; padding: 0.75rem;">${new Date(user.created_at).toLocaleDateString()}</td>
                    <td style="text-align: center; padding: 0.75rem;">
                        <button onclick="event.stopPropagation(); viewUserTasks('${user.id}')" style="margin-right: 0.5rem; padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Tasks</button>
                        <button onclick="event.stopPropagation(); viewUserNotes('${user.id}')" style="padding: 0.25rem 0.5rem; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Notes</button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        function showUserModal(user) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';

            const modalContent = document.createElement('div');
            modalContent.style.background = 'white';
            modalContent.style.padding = '2rem';
            modalContent.style.borderRadius = '8px';
            modalContent.style.maxWidth = '500px';
            modalContent.style.width = '90%';
            modalContent.style.maxHeight = '80vh';
            modalContent.style.overflow = 'auto';

            modalContent.innerHTML = `
                <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ${user.profile_image ?
                        `<img src="${user.profile_image}" alt="Profile" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">` :
                        '<div style="width: 48px; height: 48px; border-radius: 50%; background: var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ðŸ‘¤</div>'
                    }
                    ${user.username}
                    ${user.oauth_provider ? `<span title="${user.oauth_provider}">${user.oauth_provider === 'google' ? 'ðŸ”µ' : 'ðŸ”—'}</span>` : ''}
                </h3>
                <div style="margin: 1rem 0;">
                    <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                    <p><strong>Tasks:</strong> ${user.task_count}</p>
                    <p><strong>Notes:</strong> ${user.note_count}</p>
                    <p><strong>Admin:</strong> ${user.is_admin ? 'Yes' : 'No'}</p>
                    <p><strong>Joined:</strong> ${new Date(user.created_at).toLocaleDateString()}</p>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button onclick="editUser('${user.id}')" style="padding: 0.5rem 1rem; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Edit User</button>
                    <button onclick="deleteUser('${user.id}')" style="padding: 0.5rem 1rem; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete User</button>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.5rem 1rem; background: #9E9E9E; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function showUserModalFromData(rowElement) {
            const userData = JSON.parse(rowElement.getAttribute('data-user'));
            showUserModal(userData);
        }

        function viewUserTasks(userId) {
            window.open(`/admin/user/${userId}/tasks`, '_blank');
        }

        function viewUserNotes(userId) {
            window.open(`/admin/user/${userId}/notes`, '_blank');
        }

        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            const newUsername = prompt('Enter new username:', user.username);
            const newEmail = prompt('Enter new email:', user.email || '');
            const newIsAdmin = confirm(`Make ${newUsername} an admin? ${user.is_admin ? '(Currently admin)' : '(Currently not admin)'}`);

            if (newUsername !== null) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: newUsername,
                            email: newEmail,
                            is_admin: newIsAdmin
                        })
                    });

                    if (response.ok) {
                        alert('User updated successfully!');
                        loadUsers();
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.message);
                    }
                } catch (error) {
                    alert('Error updating user: ' + error.message);
                }
            }
        }

        async function deleteUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`Are you sure you want to delete user "${user.username}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('User deleted successfully!');
                        loadUsers();
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.message);
                    }
                } catch (error) {
                    alert('Error deleting user: ' + error.message);
                }
            }
        }

        // Search functionality - real-time search triggered by input
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const tableRows = document.querySelectorAll('#usersTableBody tr');

            if (!searchTerm) {
                // Show all users if search is empty
                tableRows.forEach(row => row.style.display = '');
                return;
            }

            const filteredUsers = allUsers.filter(user => {
                const username = user.username.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const taskCount = user.task_count.toString();
                const noteCount = user.note_count.toString();
                const adminStatus = user.is_admin ? 'admin' : 'user';
                const oauthProvider = (user.oauth_provider || '').toLowerCase();

                // Semantic search: check multiple fields with partial matches
                return username.includes(searchTerm) ||
                       email.includes(searchTerm) ||
                       taskCount.includes(searchTerm) ||
                       noteCount.includes(searchTerm) ||
                       adminStatus.includes(searchTerm) ||
                       oauthProvider.includes(searchTerm) ||
                       // Check if search term matches parts of username (e.g., "john" matches "john.doe")
                       username.split('.').some(part => part.includes(searchTerm)) ||
                       // Check if search term is a number and matches task/note counts
                       (!isNaN(searchTerm) && (user.task_count === parseInt(searchTerm) || user.note_count === parseInt(searchTerm)));
            });

            // Show/hide rows based on search results
            tableRows.forEach((row, index) => {
                const user = allUsers[index];
                if (user && filteredUsers.includes(user)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Refresh button
        document.getElementById('refreshUsers').addEventListener('click', loadUsers);

        // Initialize allUsers with server-rendered data for immediate search functionality
        allUsers = JSON.parse('{{ all_users | tojson | safe }}');

        // Load fresh users data in background for refresh functionality
        loadUsers();

        // Debug: Check if users are loaded
        console.log('Dashboard loaded, users rendered server-side and loaded for search');
    </script>
</body>
</html>